System.register(['typescript', './logger', './factory', './format-errors', './utils'], function(exports_1) {
    var ts, logger_1, factory_1, format_errors_1, utils_1;
    var logger, factory;
    function translate(load) {
        var _this = this;
        logger.debug("systemjs translating " + load.address);
        return factory.then(function (_a) {
            var transpiler = _a.transpiler, resolver = _a.resolver, typeChecker = _a.typeChecker, host = _a.host;
            host.addFile(load.address, load.source);
            if (utils_1.isTypescriptDeclaration(load.address)) {
                load.source = "";
            }
            else {
                var result = transpiler.transpile(load.address);
                format_errors_1.formatErrors(result.errors, logger);
                if (result.failure)
                    throw new Error("TypeScript transpilation failed");
                if (_this.loader && (host.options.module === 4))
                    load.source = wrapSource(result.js, load);
                else
                    load.source = result.js;
                if (result.sourceMap)
                    load.metadata.sourceMap = result.sourceMap;
                if (host.options.module === 4)
                    load.metadata.format = 'register';
                else if (host.options.module === 5)
                    load.metadata.format = 'esm';
                else if (host.options.module === 1)
                    load.metadata.format = 'cjs';
            }
            if (host.options.typeCheck && utils_1.isTypescript(load.address)) {
                return resolver.resolve(load.address)
                    .then(function (deps) {
                    var diags = typeChecker.check();
                    format_errors_1.formatErrors(diags, logger);
                    deps.list
                        .filter(utils_1.isTypescriptDeclaration)
                        .forEach(function (d) { return System.import(d + "!"); });
                    return load.source;
                });
            }
            else {
                return load.source;
            }
        });
    }
    exports_1("translate", translate);
    function bundle() {
        return factory.then(function (_a) {
            var typeChecker = _a.typeChecker, host = _a.host;
            if (host.options.typeCheck) {
                var errors = typeChecker.forceCheck();
                if (errors.length > 0) {
                    format_errors_1.formatErrors(errors, logger);
                    if (host.options.typeCheck === "strict")
                        throw new Error("Typescript compilation failed");
                }
            }
            return [];
        });
    }
    exports_1("bundle", bundle);
    function validateOptions(options) {
        if (options.module != 4) {
            if ((!System.transpiler || System.transpiler.indexOf("babel") < 0) || (options.target != 2))
                logger.warn("transpiling to " + ts.ModuleKind[options.module] + ", consider setting module: \"system\" in typescriptOptions to transpile directly to System.register format");
        }
    }
    function wrapSource(source, load) {
        return '(function(__moduleName){' + source + '\n})("' + load.name + '");\n//# sourceURL=' + load.address + '!transpiled';
    }
    function _resolve(dep, parent) {
        return System.normalize(dep, parent)
            .then(function (normalized) {
            normalized = utils_1.stripDoubleExtension(normalized);
            logger.debug("resolved " + normalized + " (" + parent + " -> " + dep + ")");
            return ts.normalizePath(normalized);
        });
    }
    function _fetch(address) {
        return System.fetch({ address: address, name: address, metadata: {} })
            .then(function (text) {
            logger.debug("fetched " + address);
            return text;
        });
    }
    return {
        setters:[
            function (ts_1) {
                ts = ts_1;
            },
            function (logger_1_1) {
                logger_1 = logger_1_1;
            },
            function (factory_1_1) {
                factory_1 = factory_1_1;
            },
            function (format_errors_1_1) {
                format_errors_1 = format_errors_1_1;
            },
            function (utils_1_1) {
                utils_1 = utils_1_1;
            }],
        execute: function() {
            logger = new logger_1.default({ debug: false });
            factory = factory_1.createFactory(System.typescriptOptions, _resolve, _fetch)
                .then(function (output) {
                validateOptions(output.host.options);
                return output;
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3BsdWdpbi50cyJdLCJuYW1lcyI6WyJ0cmFuc2xhdGUiLCJidW5kbGUiLCJ2YWxpZGF0ZU9wdGlvbnMiLCJ3cmFwU291cmNlIiwiX3Jlc29sdmUiLCJfZmV0Y2giXSwibWFwcGluZ3MiOiI7O1FBT00sTUFBTSxFQUNOLE9BQU87SUFZYixtQkFBMEIsSUFBWTtRQUF0Q0EsaUJBcURDQTtRQXBEQUEsTUFBTUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsMEJBQXdCQSxJQUFJQSxDQUFDQSxPQUFTQSxDQUFDQSxDQUFDQTtRQUVyREEsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBQ0EsRUFBeUNBO2dCQUF4Q0EsVUFBVUEsa0JBQUVBLFFBQVFBLGdCQUFFQSxXQUFXQSxtQkFBRUEsSUFBSUE7WUFDeERBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLEVBQUVBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1lBR3hDQSxFQUFFQSxDQUFDQSxDQUFDQSwrQkFBdUJBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUN6Q0EsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsRUFBRUEsQ0FBQ0E7WUFDcEJBLENBQUNBO1lBQ0RBLElBQUlBLENBQUNBLENBQUNBO2dCQUNIQSxJQUFNQSxNQUFNQSxHQUFHQSxVQUFVQSxDQUFDQSxTQUFTQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtnQkFDbERBLDRCQUFZQSxDQUFDQSxNQUFNQSxDQUFDQSxNQUFNQSxFQUFFQSxNQUFNQSxDQUFDQSxDQUFDQTtnQkFFcENBLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBO29CQUNoQkEsTUFBTUEsSUFBSUEsS0FBS0EsQ0FBQ0EsaUNBQWlDQSxDQUFDQSxDQUFDQTtnQkFF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QyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiAqL1xuaW1wb3J0ICogYXMgdHMgZnJvbSAndHlwZXNjcmlwdCc7XG5pbXBvcnQgTG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7Y3JlYXRlRmFjdG9yeX0gZnJvbSAnLi9mYWN0b3J5JztcbmltcG9ydCB7Zm9ybWF0RXJyb3JzfSBmcm9tICcuL2Zvcm1hdC1lcnJvcnMnO1xuaW1wb3J0IHtpc1R5cGVzY3JpcHQsIGlzVHlwZXNjcmlwdERlY2xhcmF0aW9uLCBzdHJpcERvdWJsZUV4dGVuc2lvbn0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IGxvZ2dlciA9IG5ldyBMb2dnZXIoeyBkZWJ1ZzogZmFsc2UgfSk7XG5jb25zdCBmYWN0b3J5ID0gY3JlYXRlRmFjdG9yeShTeXN0ZW0udHlwZXNjcmlwdE9wdGlvbnMsIF9yZXNvbHZlLCBfZmV0Y2gpXG4gICAudGhlbigob3V0cHV0KSA9PiB7XG4gICAgICB2YWxpZGF0ZU9wdGlvbnMob3V0cHV0Lmhvc3Qub3B0aW9ucyk7XG4gICAgICByZXR1cm4gb3V0cHV0O1xuICAgfSk7XG4gICBcbi8qXG4gKiBsb2FkLm5hbWVcbiAqIGxvYWQuYWRkcmVzc1xuICogbG9hZC5tZXRhZGF0YVxuICogbG9hZC5zb3VyY2U6IHRoZSBmZXRjaGVkIHNvdXJjZVxuICovXG5leHBvcnQgZnVuY3Rpb24gdHJhbnNsYXRlKGxvYWQ6IE1vZHVsZSk6IFByb21pc2U8c3RyaW5nPiB7XG5cdGxvZ2dlci5kZWJ1Zyhgc3lzdGVtanMgdHJhbnNsYXRpbmcgJHtsb2FkLmFkZHJlc3N9YCk7XG5cblx0cmV0dXJuIGZhY3RvcnkudGhlbigoe3RyYW5zcGlsZXIsIHJlc29sdmVyLCB0eXBlQ2hlY2tlciwgaG9zdH0pID0+IHsgICAgICAgICAgICBcbiAgICAgIGhvc3QuYWRkRmlsZShsb2FkLmFkZHJlc3MsIGxvYWQuc291cmNlKTtcblxuICAgICAgLy8gdHJhbnNwaWxlXG4gICAgICBpZiAoaXNUeXBlc2NyaXB0RGVjbGFyYXRpb24obG9hZC5hZGRyZXNzKSkge1xuICAgICAgICAgbG9hZC5zb3VyY2UgPSBcIlwiO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgICBjb25zdCByZXN1bHQgPSB0cmFuc3BpbGVyLnRyYW5zcGlsZShsb2FkLmFkZHJlc3MpO1xuICAgICAgICAgZm9ybWF0RXJyb3JzKHJlc3VsdC5lcnJvcnMsIGxvZ2dlcik7XG5cbiAgICAgICAgIGlmIChyZXN1bHQuZmFpbHVyZSlcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlR5cGVTY3JpcHQgdHJhbnNwaWxhdGlvbiBmYWlsZWRcIik7XG5cbiAgICAgICAgIGlmICh0aGlzLmxvYWRlciAmJiAoaG9zdC5vcHRpb25zLm1vZHVsZSA9PT0gdHMuTW9kdWxlS2luZC5TeXN0ZW0pKVxuICAgICAgICAgICAgbG9hZC5zb3VyY2UgPSB3cmFwU291cmNlKHJlc3VsdC5qcywgbG9hZCk7XG4gICAgICAgICBlbHNlIFxuICAgICAgICAgICAgbG9hZC5zb3VyY2UgPSByZXN1bHQuanM7XG4gICAgICAgICBcbiAgICAgICAgIGlmIChyZXN1bHQuc291cmNlTWFwKVxuICAgICAgICAgICAgbG9hZC5tZXRhZGF0YS5zb3VyY2VNYXAgPSByZXN1bHQuc291cmNlTWFwO1xuICAgICAgICAgXG4gICAgICAgICBpZiAoaG9zdC5vcHRpb25zLm1vZHVsZSA9PT0gdHMuTW9kdWxlS2luZC5TeXN0ZW0pXG4gICAgICAgICAgICBsb2FkLm1ldGFkYXRhLmZvcm1hdCA9ICdyZWdpc3Rlcic7XG4gICAgICAgICBlbHNlIGlmIChob3N0Lm9wdGlvbnMubW9kdWxlID09PSB0cy5Nb2R1bGVLaW5kLkVTNilcbiAgICAgICAgICAgIGxvYWQubWV0YWRhdGEuZm9ybWF0ID0gJ2VzbSc7XHRcdFx0XG4gICAgICAgICBlbHNlIGlmIChob3N0Lm9wdGlvbnMubW9kdWxlID09PSB0cy5Nb2R1bGVLaW5kLkNvbW1vbkpTKVxuICAgICAgICAgICAgbG9hZC5tZXRhZGF0YS5mb3JtYXQgPSAnY2pzJztcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gdHlwZS1jaGVjaz9cbiAgICAgIGlmIChob3N0Lm9wdGlvbnMudHlwZUNoZWNrICYmIGlzVHlwZXNjcmlwdChsb2FkLmFkZHJlc3MpKSB7XG4gICAgICAgICByZXR1cm4gcmVzb2x2ZXIucmVzb2x2ZShsb2FkLmFkZHJlc3MpXG4gICAgICAgICAgICAudGhlbihkZXBzID0+IHtcbiAgICAgICAgICAgICAgIHZhciBkaWFncyA9IHR5cGVDaGVja2VyLmNoZWNrKCk7XG4gICAgICAgICAgICAgICBmb3JtYXRFcnJvcnMoZGlhZ3MsIGxvZ2dlcik7XG4gICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgIC8vIHRoaXMgbWFrZXMgU3lzdGVtSlMgZmV0Y2ggb3VyIGRlY2xhcmF0aW9uIGZpbGVzIGZvciB1c1xuICAgICAgICAgICAgICAgLy9sb2FkLm1ldGFkYXRhLmRlcHMgPSBkZXBzLmxpc3QuZmlsdGVyKGlzVHlwZXNjcmlwdERlY2xhcmF0aW9uKS5tYXAoZCA9PiBkICsgXCIhXCIpO1xuICAgICAgICAgICAgICAgZGVwcy5saXN0XG4gICAgICAgICAgICAgICAgICAuZmlsdGVyKGlzVHlwZXNjcmlwdERlY2xhcmF0aW9uKVxuICAgICAgICAgICAgICAgICAgLmZvckVhY2goZCA9PiBTeXN0ZW0uaW1wb3J0KGQgKyBcIiFcIikpO1xuICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICByZXR1cm4gbG9hZC5zb3VyY2U7XG4gICAgICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICAgcmV0dXJuIGxvYWQuc291cmNlOyAgICAgICAgICAgICAgICAgIFxuICAgICAgfVxuICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidW5kbGUoKSB7XG4gICByZXR1cm4gZmFjdG9yeS50aGVuKCh7dHlwZUNoZWNrZXIsIGhvc3R9KSA9PiB7XG4gICAgICBcbiAgICAgIGlmIChob3N0Lm9wdGlvbnMudHlwZUNoZWNrKSB7XG4gICAgICAgICBjb25zdCBlcnJvcnMgPSB0eXBlQ2hlY2tlci5mb3JjZUNoZWNrKCk7XG4gICAgICAgICBcbiAgICAgICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgZm9ybWF0RXJyb3JzKGVycm9ycywgbG9nZ2VyKTtcblxuICAgICAgICAgICAgaWYgKGhvc3Qub3B0aW9ucy50eXBlQ2hlY2sgPT09IFwic3RyaWN0XCIpXG4gICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUeXBlc2NyaXB0IGNvbXBpbGF0aW9uIGZhaWxlZFwiKTtcbiAgICAgICAgIH1cbiAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgcmV0dXJuIFtdO1xuICAgfSk7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlT3B0aW9ucyhvcHRpb25zKSB7XG4gICAvKiBUaGUgb25seSB0aW1lIHlvdSBkb24ndCB3YW50IHRvIG91dHB1dCBpbiBzeXN0ZW0gZm9ybWF0IGlzIHdoZW4geW91IGFyZSB1c2luZyBiYWJlbCBcbiAgICAgIGRvd25zdHJlYW0gdG8gY29tcGlsZSBlczYgb3V0cHV0IChlLmcuIGZvciBhc3luYy9hd2FpdCBzdXBwb3J0KSAqLyAgICAgIFxuICAgaWYgKG9wdGlvbnMubW9kdWxlICE9IHRzLk1vZHVsZUtpbmQuU3lzdGVtKSB7ICAgICAgXG4gICAgICBpZiAoKCFTeXN0ZW0udHJhbnNwaWxlciB8fCBTeXN0ZW0udHJhbnNwaWxlci5pbmRleE9mKFwiYmFiZWxcIikgPCAwKSB8fCAob3B0aW9ucy50YXJnZXQgIT0gdHMuU2NyaXB0VGFyZ2V0LkVTNikpXG4gICAgICAgICBsb2dnZXIud2FybihgdHJhbnNwaWxpbmcgdG8gJHsoPGFueT50cykuTW9kdWxlS2luZFtvcHRpb25zLm1vZHVsZV19LCBjb25zaWRlciBzZXR0aW5nIG1vZHVsZTogXCJzeXN0ZW1cIiBpbiB0eXBlc2NyaXB0T3B0aW9ucyB0byB0cmFuc3BpbGUgZGlyZWN0bHkgdG8gU3lzdGVtLnJlZ2lzdGVyIGZvcm1hdGApO1xuICAgfVxufVxuXG5mdW5jdGlvbiB3cmFwU291cmNlKHNvdXJjZTogc3RyaW5nLCBsb2FkOiBNb2R1bGUpOiBzdHJpbmcge1xuXHRyZXR1cm4gJyhmdW5jdGlvbihfX21vZHVsZU5hbWUpeycgKyBzb3VyY2UgKyAnXFxufSkoXCInICsgbG9hZC5uYW1lICsgJ1wiKTtcXG4vLyMgc291cmNlVVJMPScgKyBsb2FkLmFkZHJlc3MgKyAnIXRyYW5zcGlsZWQnO1xufVxuXG4vKlxuICogY2FsbGVkIGJ5IHRoZSBmYWN0b3J5L3Jlc29sdmVyIHdoZW4gaXQgbmVlZHMgdG8gcmVzb2x2ZSBhIGZpbGVcbiAqL1xuZnVuY3Rpb24gX3Jlc29sdmUoZGVwOiBzdHJpbmcsIHBhcmVudDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcblx0Ly8gVE9ETzogX19tb2R1bGVOYW1lIGlzIG5vdCBhdmFpbGFibGUgd2l0aG91dCBhIGJ1aWx0LWluIHRyYW5zcGlsZXJcblx0Ly9pZiAoIXBhcmVudCkgcGFyZW50ID0gX19tb2R1bGVOYW1lO1xuXG5cdHJldHVybiBTeXN0ZW0ubm9ybWFsaXplKGRlcCwgcGFyZW50KVxuXHRcdC50aGVuKG5vcm1hbGl6ZWQgPT4ge1xuXHRcdFx0bm9ybWFsaXplZCA9IHN0cmlwRG91YmxlRXh0ZW5zaW9uKG5vcm1hbGl6ZWQpO1xuXG5cdFx0XHRsb2dnZXIuZGVidWcoYHJlc29sdmVkICR7bm9ybWFsaXplZH0gKCR7cGFyZW50fSAtPiAke2RlcH0pYCk7XG4gICAgICAgICByZXR1cm4gKHRzIGFzIGFueSkubm9ybWFsaXplUGF0aChub3JtYWxpemVkKTtcblx0XHR9KTtcbn1cblxuLypcbiAqIGNhbGxlZCBieSB0aGUgZmFjdG9yeS9yZXNvbHZlciB3aGVuIGl0IG5lZWRzIHRvIGZldGNoIGEgZmlsZVxuICovXG5mdW5jdGlvbiBfZmV0Y2goYWRkcmVzczogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcblx0cmV0dXJuIFN5c3RlbS5mZXRjaCh7IGFkZHJlc3M6IGFkZHJlc3MsIG5hbWU6IGFkZHJlc3MsIG1ldGFkYXRhOiB7fSB9KVxuXHRcdC50aGVuKHRleHQgPT4ge1xuXHRcdFx0bG9nZ2VyLmRlYnVnKGBmZXRjaGVkICR7YWRkcmVzc31gKTtcblx0XHRcdHJldHVybiB0ZXh0O1xuXHRcdH0pO1xufVxuIl19