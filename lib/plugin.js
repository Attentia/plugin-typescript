var ts = require('typescript');
var logger_1 = require('./logger');
var factory_1 = require('./factory');
var format_errors_1 = require('./format-errors');
var utils_1 = require('./utils');
var logger = new logger_1.default({ debug: false });
var factory = factory_1.createFactory(System.typescriptOptions, _resolve, _fetch);
var typeCheckErrored = false;
function translate(load) {
    var _this = this;
    logger.debug("systemjs translating " + load.address);
    return factory.then(function (_a) {
        var transpiler = _a.transpiler, typeChecker = _a.typeChecker, host = _a.host;
        var result = transpiler.transpile(load.address, load.source);
        format_errors_1.formatErrors(result.errors, logger);
        if (result.failure)
            throw new Error("TypeScript transpilation failed");
        if (host.options.typeCheck && utils_1.isTypescript(load.address)) {
            typeChecker.check(load.address, load.source)
                .catch(function (err) { return logger.error(err.message); })
                .then(function (diags) {
                format_errors_1.formatErrors(diags, logger);
                if (diags.some(function (diag) { return diag.category === ts.DiagnosticCategory.Error; }))
                    typeCheckErrored = true;
            });
        }
        if (_this.loader && (host.options.module === 4))
            load.source = wrapSource(result.js, load);
        else
            load.source = result.js;
        if (result.sourceMap) {
            if (System.transpiler && System.transpiler.indexOf("babel") >= 0)
                load.metadata.sourceMap = JSON.parse(result.sourceMap);
            else
                load.metadata.sourceMap = result.sourceMap;
        }
        if (host.options.module === 4)
            load.metadata.format = 'register';
        else if (host.options.module === 5)
            load.metadata.format = 'esm';
        return load.source;
    });
}
exports.translate = translate;
function wrapSource(source, load) {
    return '(function(__moduleName){' + source + '\n})("' + load.name + '");\n//# sourceURL=' + load.address + '!transpiled';
}
function bundle() {
    if (typeCheckErrored && System.typescriptOptions.typeCheck === "strict") {
        typeCheckErrored = false;
        throw new Error("TypeScript found type errors");
    }
    return [];
}
exports.bundle = bundle;
function _resolve(dep, parent) {
    return System.normalize(dep, parent)
        .then(function (normalized) {
        normalized = utils_1.stripDoubleExtension(normalized);
        logger.debug("resolved " + normalized + " (" + parent + " -> " + dep + ")");
        return normalized;
    });
}
function _fetch(address) {
    return System.fetch({ address: address, name: address, metadata: {} })
        .then(function (text) {
        logger.debug("fetched " + address);
        return text;
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3BsdWdpbi50cyJdLCJuYW1lcyI6WyJ0cmFuc2xhdGUiLCJ3cmFwU291cmNlIiwiYnVuZGxlIiwiX3Jlc29sdmUiLCJfZmV0Y2giXSwibWFwcGluZ3MiOiJBQUNBLElBQVksRUFBRSxXQUFNLFlBQVksQ0FBQyxDQUFBO0FBQ2pDLHVCQUFtQixVQUFVLENBQUMsQ0FBQTtBQUM5Qix3QkFBNEIsV0FBVyxDQUFDLENBQUE7QUFDeEMsOEJBQTJCLGlCQUFpQixDQUFDLENBQUE7QUFDN0Msc0JBQWlELFNBQVMsQ0FBQyxDQUFBO0FBRTNELElBQUksTUFBTSxHQUFHLElBQUksZ0JBQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0FBQzFDLElBQUksT0FBTyxHQUFHLHVCQUFhLENBQUMsTUFBTSxDQUFDLGlCQUFpQixFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUN4RSxJQUFJLGdCQUFnQixHQUFHLEtBQUssQ0FBQztBQVE3QixtQkFBMEIsSUFBWTtJQUF0Q0EsaUJBd0NDQTtJQXZDQUEsTUFBTUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsMEJBQXdCQSxJQUFJQSxDQUFDQSxPQUFTQSxDQUFDQSxDQUFDQTtJQUVyREEsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBQ0EsRUFBK0JBO1lBQTlCQSxVQUFVQSxrQkFBRUEsV0FBV0EsbUJBQUVBLElBQUlBO1FBQ2xEQSxJQUFJQSxNQUFNQSxHQUFHQSxVQUFVQSxDQUFDQSxTQUFTQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxFQUFFQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUM3REEsNEJBQVlBLENBQUNBLE1BQU1BLENBQUNBLE1BQU1BLEVBQUVBLE1BQU1BLENBQUNBLENBQUNBO1FBRXBDQSxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQTtZ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Q0EsQ0FBQ0EsQ0FBQUE7QUFDSkEsQ0FBQ0EiLCJzb3VyY2VzQ29udGVudCI6WyIvKiAqL1xuaW1wb3J0ICogYXMgdHMgZnJvbSAndHlwZXNjcmlwdCc7XG5pbXBvcnQgTG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7Y3JlYXRlRmFjdG9yeX0gZnJvbSAnLi9mYWN0b3J5JztcbmltcG9ydCB7Zm9ybWF0RXJyb3JzfSBmcm9tICcuL2Zvcm1hdC1lcnJvcnMnO1xuaW1wb3J0IHtpc1R5cGVzY3JpcHQsIHN0cmlwRG91YmxlRXh0ZW5zaW9ufSBmcm9tICcuL3V0aWxzJztcblxubGV0IGxvZ2dlciA9IG5ldyBMb2dnZXIoeyBkZWJ1ZzogZmFsc2UgfSk7XG5sZXQgZmFjdG9yeSA9IGNyZWF0ZUZhY3RvcnkoU3lzdGVtLnR5cGVzY3JpcHRPcHRpb25zLCBfcmVzb2x2ZSwgX2ZldGNoKTtcbmxldCB0eXBlQ2hlY2tFcnJvcmVkID0gZmFsc2U7XG5cbi8qXG4gKiBsb2FkLm5hbWVcbiAqIGxvYWQuYWRkcmVzc1xuICogbG9hZC5tZXRhZGF0YVxuICogbG9hZC5zb3VyY2U6IHRoZSBmZXRjaGVkIHNvdXJjZVxuICovXG5leHBvcnQgZnVuY3Rpb24gdHJhbnNsYXRlKGxvYWQ6IE1vZHVsZSk6IFByb21pc2U8c3RyaW5nPiB7XG5cdGxvZ2dlci5kZWJ1Zyhgc3lzdGVtanMgdHJhbnNsYXRpbmcgJHtsb2FkLmFkZHJlc3N9YCk7XG5cblx0cmV0dXJuIGZhY3RvcnkudGhlbigoe3RyYW5zcGlsZXIsIHR5cGVDaGVja2VyLCBob3N0fSkgPT4ge1xuXHRcdGxldCByZXN1bHQgPSB0cmFuc3BpbGVyLnRyYW5zcGlsZShsb2FkLmFkZHJlc3MsIGxvYWQuc291cmNlKTtcblx0XHRmb3JtYXRFcnJvcnMocmVzdWx0LmVycm9ycywgbG9nZ2VyKTtcblxuXHRcdGlmIChyZXN1bHQuZmFpbHVyZSlcblx0XHRcdHRocm93IG5ldyBFcnJvcihcIlR5cGVTY3JpcHQgdHJhbnNwaWxhdGlvbiBmYWlsZWRcIik7XG5cblx0XHRpZiAoaG9zdC5vcHRpb25zLnR5cGVDaGVjayAmJiBpc1R5cGVzY3JpcHQobG9hZC5hZGRyZXNzKSkge1xuXHRcdFx0dHlwZUNoZWNrZXIuY2hlY2sobG9hZC5hZGRyZXNzLCBsb2FkLnNvdXJjZSlcblx0XHRcdFx0LmNhdGNoKGVyciA9PiBsb2dnZXIuZXJyb3IoZXJyLm1lc3NhZ2UpKVxuXHRcdFx0XHQudGhlbihkaWFncyA9PiB7XG5cdFx0XHRcdFx0Zm9ybWF0RXJyb3JzKGRpYWdzLCBsb2dnZXIpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGlmIChkaWFncy5zb21lKGRpYWcgPT4gZGlhZy5jYXRlZ29yeSA9PT0gdHMuRGlhZ25vc3RpY0NhdGVnb3J5LkVycm9yKSlcblx0XHRcdFx0XHRcdHR5cGVDaGVja0Vycm9yZWQgPSB0cnVlO1xuXHRcdFx0XHR9KTtcblx0XHR9XG5cblx0XHRpZiAodGhpcy5sb2FkZXIgJiYgKGhvc3Qub3B0aW9ucy5tb2R1bGUgPT09IHRzLk1vZHVsZUtpbmQuU3lzdGVtKSlcblx0XHRcdGxvYWQuc291cmNlID0gd3JhcFNvdXJjZShyZXN1bHQuanMsIGxvYWQpO1xuXHRcdGVsc2UgXG5cdFx0XHRsb2FkLnNvdXJjZSA9IHJlc3VsdC5qcztcblx0XHRcblx0XHRpZiAocmVzdWx0LnNvdXJjZU1hcCkge1xuICAgICAgICAgaWYgKFN5c3RlbS50cmFuc3BpbGVyICYmIFN5c3RlbS50cmFuc3BpbGVyLmluZGV4T2YoXCJiYWJlbFwiKSA+PSAwKVxuICAgXHRcdFx0bG9hZC5tZXRhZGF0YS5zb3VyY2VNYXAgPSBKU09OLnBhcnNlKHJlc3VsdC5zb3VyY2VNYXApO1xuICAgICAgICAgZWxzZVxuICAgICAgICAgICAgbG9hZC5tZXRhZGF0YS5zb3VyY2VNYXAgPSByZXN1bHQuc291cmNlTWFwO1xuICAgICAgfVxuXHRcdFxuXHRcdGlmIChob3N0Lm9wdGlvbnMubW9kdWxlID09PSB0cy5Nb2R1bGVLaW5kLlN5c3RlbSlcblx0XHRcdGxvYWQubWV0YWRhdGEuZm9ybWF0ID0gJ3JlZ2lzdGVyJztcblx0XHRlbHNlIGlmIChob3N0Lm9wdGlvbnMubW9kdWxlID09PSB0cy5Nb2R1bGVLaW5kLkVTNilcblx0XHRcdGxvYWQubWV0YWRhdGEuZm9ybWF0ID0gJ2VzbSc7XHRcdFx0XG5cblx0XHRyZXR1cm4gbG9hZC5zb3VyY2U7XG5cdH0pO1xufVxuXG5mdW5jdGlvbiB3cmFwU291cmNlKHNvdXJjZTogc3RyaW5nLCBsb2FkOiBNb2R1bGUpOiBzdHJpbmcge1xuXHRyZXR1cm4gJyhmdW5jdGlvbihfX21vZHVsZU5hbWUpeycgKyBzb3VyY2UgKyAnXFxufSkoXCInICsgbG9hZC5uYW1lICsgJ1wiKTtcXG4vLyMgc291cmNlVVJMPScgKyBsb2FkLmFkZHJlc3MgKyAnIXRyYW5zcGlsZWQnO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVuZGxlKCkge1xuXHRpZiAodHlwZUNoZWNrRXJyb3JlZCAmJiBTeXN0ZW0udHlwZXNjcmlwdE9wdGlvbnMudHlwZUNoZWNrID09PSBcInN0cmljdFwiKSB7XG5cdFx0dHlwZUNoZWNrRXJyb3JlZCA9IGZhbHNlO1xuXHRcdHRocm93IG5ldyBFcnJvcihcIlR5cGVTY3JpcHQgZm91bmQgdHlwZSBlcnJvcnNcIik7XG5cdH1cblx0XG5cdHJldHVybiBbXTtcbn1cblxuLypcbiAqIGNhbGxlZCBieSB0aGUgdHlwZS1jaGVja2VyIHdoZW4gaXQgbmVlZHMgdG8gcmVzb2x2ZSBhIGZpbGVcbiAqL1xuZnVuY3Rpb24gX3Jlc29sdmUoZGVwOiBzdHJpbmcsIHBhcmVudDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcblx0Ly8gVE9ETzogX19tb2R1bGVOYW1lIGlzIG5vdCBhdmFpbGFibGUgd2l0aG91dCBhIGJ1aWx0LWluIHRyYW5zcGlsZXJcblx0Ly9pZiAoIXBhcmVudCkgcGFyZW50ID0gX19tb2R1bGVOYW1lO1xuXG5cdHJldHVybiBTeXN0ZW0ubm9ybWFsaXplKGRlcCwgcGFyZW50KVxuXHRcdC50aGVuKG5vcm1hbGl6ZWQgPT4ge1xuXHRcdFx0bm9ybWFsaXplZCA9IHN0cmlwRG91YmxlRXh0ZW5zaW9uKG5vcm1hbGl6ZWQpO1xuXG5cdFx0XHRsb2dnZXIuZGVidWcoYHJlc29sdmVkICR7bm9ybWFsaXplZH0gKCR7cGFyZW50fSAtPiAke2RlcH0pYCk7XG5cdFx0XHRyZXR1cm4gbm9ybWFsaXplZDtcblx0XHR9KTtcbn1cblxuLypcbiAqIGNhbGxlZCBieSB0aGUgdHlwZS1jaGVja2VyIHdoZW4gaXQgbmVlZHMgdG8gZmV0Y2ggYSBmaWxlXG4gKi9cbmZ1bmN0aW9uIF9mZXRjaChhZGRyZXNzOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuXHRyZXR1cm4gU3lzdGVtLmZldGNoKHsgYWRkcmVzczogYWRkcmVzcywgbmFtZTogYWRkcmVzcywgbWV0YWRhdGE6IHt9IH0pXG5cdFx0LnRoZW4odGV4dCA9PiB7XG5cdFx0XHRsb2dnZXIuZGVidWcoYGZldGNoZWQgJHthZGRyZXNzfWApO1xuXHRcdFx0cmV0dXJuIHRleHQ7XG5cdFx0fSlcbn1cbiJdfQ==