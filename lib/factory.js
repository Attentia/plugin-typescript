var ts = require('typescript');
var logger_1 = require('./logger');
var compiler_host_1 = require('./compiler-host');
var transpiler_1 = require('./transpiler');
var type_checker_1 = require('./type-checker');
var format_errors_1 = require('./format-errors');
var utils_1 = require("./utils");
var logger = new logger_1.default({ debug: false });
function createFactory(sjsconfig, _resolve, _fetch) {
    var tsconfigFiles = [];
    var typingsFiles = [];
    return loadOptions(sjsconfig, _resolve, _fetch)
        .then(function (options) {
        return createServices(options, _resolve, _fetch);
    })
        .then(function (services) {
        if (services.options.typeCheck) {
            return resolveDeclarationFiles(services.options, _resolve)
                .then(function (resolvedFiles) {
                resolvedFiles.forEach(function (resolvedFile) {
                    services.typeChecker.registerDeclarationFile(resolvedFile, false);
                });
                return services;
            });
        }
        else {
            return services;
        }
    });
}
exports.createFactory = createFactory;
function loadOptions(sjsconfig, _resolve, _fetch) {
    if (sjsconfig.tsconfig) {
        var tsconfig = (sjsconfig.tsconfig === true) ? "tsconfig.json" : sjsconfig.tsconfig;
        return _resolve(tsconfig)
            .then(function (tsconfigAddress) {
            return _fetch(tsconfigAddress).then(function (tsconfigText) { return ({ tsconfigText: tsconfigText, tsconfigAddress: tsconfigAddress }); });
        })
            .then(function (_a) {
            var tsconfigAddress = _a.tsconfigAddress, tsconfigText = _a.tsconfigText;
            var ts1 = ts;
            var result = ts1.parseConfigFileText ?
                ts1.parseConfigFileText(tsconfigAddress, tsconfigText) :
                ts1.parseConfigFileTextToJson(tsconfigAddress, tsconfigText);
            if (result.error) {
                format_errors_1.formatErrors([result.error], logger);
                throw new Error("failed to load tsconfig from " + tsconfigAddress);
            }
            var files = result.config.files;
            return Object.assign(result.config.compilerOptions, sjsconfig, { tsconfigAddress: tsconfigAddress, files: files });
        });
    }
    else {
        return Promise.resolve(sjsconfig);
    }
}
function resolveDeclarationFiles(options, _resolve) {
    var files = options.files || [];
    var declarationFiles = files
        .filter(function (filename) { return utils_1.isTypescriptDeclaration(filename); })
        .map(function (filename) { return _resolve(filename, options.tsconfigAddress); });
    return Promise.all(declarationFiles);
}
function createServices(options, _resolve, _fetch) {
    var host = new compiler_host_1.CompilerHost(options);
    var transpiler = new transpiler_1.Transpiler(host);
    var typeChecker = undefined;
    if (options.typeCheck) {
        typeChecker = new type_checker_1.TypeChecker(host, _resolve, _fetch);
        if (!host.options.noLib) {
            return _resolve('ts', '')
                .then(function (moduleName) {
                return _resolve(host.getDefaultLibFileName(), moduleName);
            })
                .then(function (defaultLibAddress) {
                typeChecker.registerDeclarationFile(defaultLibAddress, true);
                return { transpiler: transpiler, typeChecker: typeChecker, host: host, options: options };
            });
        }
    }
    return Promise.resolve({ transpiler: transpiler, typeChecker: typeChecker, host: host, options: options });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbImNyZWF0ZUZhY3RvcnkiLCJsb2FkT3B0aW9ucyIsInJlc29sdmVEZWNsYXJhdGlvbkZpbGVzIiwiY3JlYXRlU2VydmljZXMiXSwibWFwcGluZ3MiOiJBQUNBLElBQVksRUFBRSxXQUFNLFlBQVksQ0FBQyxDQUFBO0FBQ2pDLHVCQUFtQixVQUFVLENBQUMsQ0FBQTtBQUM5Qiw4QkFBMkIsaUJBQWlCLENBQUMsQ0FBQTtBQUM3QywyQkFBeUIsY0FBYyxDQUFDLENBQUE7QUFDeEMsNkJBQTBCLGdCQUFnQixDQUFDLENBQUE7QUFDM0MsOEJBQTJCLGlCQUFpQixDQUFDLENBQUE7QUFDN0Msc0JBQXNDLFNBQVMsQ0FBQyxDQUFBO0FBRWhELElBQUksTUFBTSxHQUFHLElBQUksZ0JBQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0FBWTFDLHVCQUE4QixTQUF3QixFQUFFLFFBQXlCLEVBQUUsTUFBcUI7SUFDdkdBLElBQUlBLGFBQWFBLEdBQUdBLEVBQUVBLENBQUNBO0lBQ3ZCQSxJQUFJQSxZQUFZQSxHQUFHQSxFQUFFQSxDQUFDQTtJQUV0QkEsTUFBTUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsU0FBU0EsRUFBRUEsUUFBUUEsRUFBRUEsTUFBTUEsQ0FBQ0E7U0FDN0NBLElBQUlBLENBQUNBLFVBQUFBLE9BQU9BO1FBQ1pBLE1BQU1BLENBQUNBLGNBQWNBLENBQUNBLE9BQU9BLEVBQUVBLFFBQVFBLEVBQUVBLE1BQU1BLENBQUNBLENBQUNBO0lBQ2xEQSxDQUFDQSxDQUFDQTtTQUNEQSxJQUFJQSxDQUFDQSxVQUFBQSxRQUFRQTtRQUNiQSxFQUFFQSxDQUFDQSxDQUFDQSxRQUFRQSxDQUFDQSxPQUFPQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNoQ0EsTUFBTUEsQ0FBQ0EsdUJBQXVCQSxDQUFDQSxRQUFR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QUFDQSxDQUFDQTtpQkFDREEsSUFBSUEsQ0FBQ0EsVUFBQUEsaUJBQWlCQTtnQkFDdEJBLFdBQVdBLENBQUNBLHVCQUF1QkEsQ0FBQ0EsaUJBQWlCQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDN0RBLE1BQU1BLENBQUNBLEVBQUNBLFlBQUFBLFVBQVVBLEVBQUVBLGFBQUFBLFdBQVdBLEVBQUVBLE1BQUFBLElBQUlBLEVBQUVBLFNBQUFBLE9BQU9BLEVBQUNBLENBQUNBO1lBQ2pEQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNMQSxDQUFDQTtJQUNGQSxDQUFDQTtJQUVEQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxFQUFDQSxZQUFBQSxVQUFVQSxFQUFFQSxhQUFBQSxXQUFXQSxFQUFFQSxNQUFBQSxJQUFJQSxFQUFFQSxTQUFBQSxPQUFPQSxFQUFDQSxDQUFDQSxDQUFDQTtBQUNsRUEsQ0FBQ0EiLCJzb3VyY2VzQ29udGVudCI6WyIvKiAqL1xuaW1wb3J0ICogYXMgdHMgZnJvbSAndHlwZXNjcmlwdCc7XG5pbXBvcnQgTG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7Q29tcGlsZXJIb3N0fSBmcm9tICcuL2NvbXBpbGVyLWhvc3QnO1xuaW1wb3J0IHtUcmFuc3BpbGVyfSBmcm9tICcuL3RyYW5zcGlsZXInO1xuaW1wb3J0IHtUeXBlQ2hlY2tlcn0gZnJvbSAnLi90eXBlLWNoZWNrZXInO1xuaW1wb3J0IHtmb3JtYXRFcnJvcnN9IGZyb20gJy4vZm9ybWF0LWVycm9ycyc7XG5pbXBvcnQge2lzVHlwZXNjcmlwdERlY2xhcmF0aW9ufSBmcm9tIFwiLi91dGlsc1wiO1xuXG5sZXQgbG9nZ2VyID0gbmV3IExvZ2dlcih7IGRlYnVnOiBmYWxzZSB9KTtcblxuaW50ZXJmYWNlIEZhY3RvcnlPdXRwdXQge1xuXHQgaG9zdDogQ29tcGlsZXJIb3N0O1xuXHQgdHJhbnNwaWxlcjogVHJhbnNwaWxlcjtcblx0IHR5cGVDaGVja2VyOiBUeXBlQ2hlY2tlcjtcblx0IG9wdGlvbnM6IFBsdWdpbk9wdGlvbnM7XG59XG5cbi8qXG5cdFRoaXMgY29kZSBsb29rcyBhIGxvdCBiZXR0ZXIgd2l0aCBhc3luYyBmdW5jdGlvbnMuLi5cbiovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRmFjdG9yeShzanNjb25maWc6IFBsdWdpbk9wdGlvbnMsIF9yZXNvbHZlOiBSZXNvbHZlRnVuY3Rpb24sIF9mZXRjaDogRmV0Y2hGdW5jdGlvbik6IFByb21pc2U8RmFjdG9yeU91dHB1dD4ge1xuXHRsZXQgdHNjb25maWdGaWxlcyA9IFtdO1xuXHRsZXQgdHlwaW5nc0ZpbGVzID0gW107XG5cblx0cmV0dXJuIGxvYWRPcHRpb25zKHNqc2NvbmZpZywgX3Jlc29sdmUsIF9mZXRjaClcblx0XHQudGhlbihvcHRpb25zID0+IHtcblx0XHRcdHJldHVybiBjcmVhdGVTZXJ2aWNlcyhvcHRpb25zLCBfcmVzb2x2ZSwgX2ZldGNoKTtcblx0XHR9KVxuXHRcdC50aGVuKHNlcnZpY2VzID0+IHtcblx0XHRcdGlmIChzZXJ2aWNlcy5vcHRpb25zLnR5cGVDaGVjaykge1xuXHRcdFx0XHRyZXR1cm4gcmVzb2x2ZURlY2xhcmF0aW9uRmlsZXMoc2VydmljZXMub3B0aW9ucywgX3Jlc29sdmUpXG5cdFx0XHRcdFx0LnRoZW4ocmVzb2x2ZWRGaWxlcyA9PiB7XG5cdFx0XHRcdFx0XHRyZXNvbHZlZEZpbGVzLmZvckVhY2gocmVzb2x2ZWRGaWxlID0+IHtcblx0XHRcdFx0XHRcdFx0c2VydmljZXMudHlwZUNoZWNrZXIucmVnaXN0ZXJEZWNsYXJhdGlvbkZpbGUocmVzb2x2ZWRGaWxlLCBmYWxzZSk7XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdHJldHVybiBzZXJ2aWNlcztcblx0XHRcdFx0XHR9KTtcblx0XHRcdH1cblx0XHRcdGVsc2Uge1xuXHRcdFx0XHRyZXR1cm4gc2VydmljZXM7XG5cdFx0XHR9XG5cdFx0fSk7XG59XG5cbmZ1bmN0aW9uIGxvYWRPcHRpb25zKHNqc2NvbmZpZzogUGx1Z2luT3B0aW9ucywgX3Jlc29sdmU6IFJlc29sdmVGdW5jdGlvbiwgX2ZldGNoOiBGZXRjaEZ1bmN0aW9uKTogUHJvbWlzZTxQbHVnaW5PcHRpb25zPiB7XG5cdGlmIChzanNjb25maWcudHNjb25maWcpIHtcblx0XHRsZXQgdHNjb25maWcgPSAoc2pzY29uZmlnLnRzY29uZmlnID09PSB0cnVlKSA/IFwidHNjb25maWcuanNvblwiIDogc2pzY29uZmlnLnRzY29uZmlnIGFzIHN0cmluZztcblxuXHRcdHJldHVybiBfcmVzb2x2ZSh0c2NvbmZpZylcblx0XHRcdC50aGVuKHRzY29uZmlnQWRkcmVzcyA9PiB7XG5cdFx0XHRcdHJldHVybiBfZmV0Y2godHNjb25maWdBZGRyZXNzKS50aGVuKHRzY29uZmlnVGV4dCA9PiAoe3RzY29uZmlnVGV4dCwgdHNjb25maWdBZGRyZXNzfSkpO1xuXHRcdFx0fSlcblx0XHRcdC50aGVuKCh7dHNjb25maWdBZGRyZXNzLCB0c2NvbmZpZ1RleHR9KSA9PiB7XG5cdFx0XHRcdGxldCB0czEgPSB0cyBhcyBhbnk7IC8vIHN1cHBvcnQgVFMgMS42LjIgYW5kID4gMS43XG5cdFx0XHRcdGxldCByZXN1bHQgPSB0czEucGFyc2VDb25maWdGaWxlVGV4dCA/XG5cdFx0XHRcdFx0dHMxLnBhcnNlQ29uZmlnRmlsZVRleHQodHNjb25maWdBZGRyZXNzLCB0c2NvbmZpZ1RleHQpIDpcblx0XHRcdFx0XHR0czEucGFyc2VDb25maWdGaWxlVGV4dFRvSnNvbih0c2NvbmZpZ0FkZHJlc3MsIHRzY29uZmlnVGV4dCk7XG5cblx0XHRcdFx0aWYgKHJlc3VsdC5lcnJvcikge1xuXHRcdFx0XHRcdGZvcm1hdEVycm9ycyhbcmVzdWx0LmVycm9yXSwgbG9nZ2VyKTtcblx0XHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoYGZhaWxlZCB0byBsb2FkIHRzY29uZmlnIGZyb20gJHt0c2NvbmZpZ0FkZHJlc3N9YCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRsZXQgZmlsZXMgPSByZXN1bHQuY29uZmlnLmZpbGVzO1xuXHRcdFx0XHRyZXR1cm4gT2JqZWN0LmFzc2lnbihyZXN1bHQuY29uZmlnLmNvbXBpbGVyT3B0aW9ucywgc2pzY29uZmlnLCB7IHRzY29uZmlnQWRkcmVzcywgZmlsZXMgfSk7XG5cdFx0XHR9KTtcblx0fVxuXHRlbHNlIHtcblx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHNqc2NvbmZpZyk7XG5cdH1cbn1cblxuZnVuY3Rpb24gcmVzb2x2ZURlY2xhcmF0aW9uRmlsZXMob3B0aW9uczogUGx1Z2luT3B0aW9ucywgX3Jlc29sdmU6IFJlc29sdmVGdW5jdGlvbik6IFByb21pc2U8c3RyaW5nW10+IHtcblx0bGV0IGZpbGVzID0gb3B0aW9ucy5maWxlcyB8fCBbXTtcblxuXHRsZXQgZGVjbGFyYXRpb25GaWxlcyA9IGZpbGVzXG5cdFx0LmZpbHRlcihmaWxlbmFtZSA9PiBpc1R5cGVzY3JpcHREZWNsYXJhdGlvbihmaWxlbmFtZSkpXG5cdFx0Lm1hcChmaWxlbmFtZSA9PiBfcmVzb2x2ZShmaWxlbmFtZSwgb3B0aW9ucy50c2NvbmZpZ0FkZHJlc3MpKTtcblxuXHRyZXR1cm4gUHJvbWlzZS5hbGw8c3RyaW5nPihkZWNsYXJhdGlvbkZpbGVzKTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlU2VydmljZXMob3B0aW9uczogUGx1Z2luT3B0aW9ucywgX3Jlc29sdmU6IFJlc29sdmVGdW5jdGlvbiwgX2ZldGNoOiBGZXRjaEZ1bmN0aW9uKTogUHJvbWlzZTxGYWN0b3J5T3V0cHV0PiB7XG5cdGxldCBob3N0ID0gbmV3IENvbXBpbGVySG9zdChvcHRpb25zKTtcblx0bGV0IHRyYW5zcGlsZXIgPSBuZXcgVHJhbnNwaWxlcihob3N0KTtcblx0bGV0IHR5cGVDaGVja2VyID0gdW5kZWZpbmVkO1xuXG5cdGlmIChvcHRpb25zLnR5cGVDaGVjaykge1xuXHRcdHR5cGVDaGVja2VyID0gbmV3IFR5cGVDaGVja2VyKGhvc3QsIF9yZXNvbHZlLCBfZmV0Y2gpO1xuXG5cdFx0aWYgKCFob3N0Lm9wdGlvbnMubm9MaWIpIHtcblx0XHRcdC8vIFRPRE8gLSByZW1vdmUgdGhpcyB3aGVuIF9fbW9kdWxlTmFtZSBpcyBhdmFpbGFibGVcblx0XHRcdHJldHVybiBfcmVzb2x2ZSgndHMnLCAnJylcblx0XHRcdFx0LnRoZW4obW9kdWxlTmFtZSA9PiB7XG5cdFx0XHRcdFx0IHJldHVybiBfcmVzb2x2ZShob3N0LmdldERlZmF1bHRMaWJGaWxlTmFtZSgpLCBtb2R1bGVOYW1lKVxuXHRcdFx0XHR9KVxuXHRcdFx0XHQudGhlbihkZWZhdWx0TGliQWRkcmVzcyA9PiB7XG5cdFx0XHRcdFx0dHlwZUNoZWNrZXIucmVnaXN0ZXJEZWNsYXJhdGlvbkZpbGUoZGVmYXVsdExpYkFkZHJlc3MsIHRydWUpO1xuXHRcdFx0XHRcdHJldHVybiB7dHJhbnNwaWxlciwgdHlwZUNoZWNrZXIsIGhvc3QsIG9wdGlvbnN9O1xuXHRcdFx0XHR9KTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHt0cmFuc3BpbGVyLCB0eXBlQ2hlY2tlciwgaG9zdCwgb3B0aW9uc30pO1xufVxuIl19