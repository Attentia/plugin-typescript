var ts = require('typescript');
var logger_1 = require('./logger');
var compiler_host_1 = require('./compiler-host');
var transpiler_1 = require('./transpiler');
var type_checker_1 = require('./type-checker');
var format_errors_1 = require('./format-errors');
var utils_1 = require("./utils");
var logger = new logger_1.default({ debug: false });
function createFactory(options, _resolve, _fetch) {
    options = options || {};
    if (options.tsconfig) {
        var tsconfig = (options.tsconfig === true) ? "tsconfig.json" : options.tsconfig;
        return _resolve(tsconfig)
            .then(function (tsconfigAddress) {
            return _fetch(tsconfigAddress)
                .then(function (tsconfigText) {
                return { tsconfigAddress: tsconfigAddress, tsconfigText: tsconfigText };
            });
        })
            .then(function (_a) {
            var tsconfigAddress = _a.tsconfigAddress, tsconfigText = _a.tsconfigText;
            var ts1 = ts;
            var result = ts1.parseConfigFileText ? ts1.parseConfigFileText(tsconfigAddress, tsconfigText) : ts1.parseConfigFileTextToJson(tsconfigAddress, tsconfigText);
            if (result.error) {
                format_errors_1.formatErrors([result.error], logger);
                throw new Error("failed to load tsconfig from " + tsconfigAddress);
            }
            var config = Object.assign(result.config.compilerOptions, options);
            var files = result.config.files || [];
            return createServices(config, _resolve, _fetch)
                .then(function (services) {
                var resolutions = files
                    .filter(function (filename) { return utils_1.isTypescriptDeclaration(filename); })
                    .map(function (filename) { return _resolve(filename, tsconfigAddress); });
                return Promise.all(resolutions)
                    .then(function (resolvedFiles) {
                    resolvedFiles.forEach(function (resolvedFile) {
                        services.typeChecker.registerDeclarationFile(resolvedFile, false);
                    });
                    return services;
                });
            });
        });
    }
    else {
        return createServices(options, _resolve, _fetch);
    }
}
exports.createFactory = createFactory;
function createServices(config, _resolve, _fetch) {
    var host = new compiler_host_1.CompilerHost(config);
    var transpiler = new transpiler_1.Transpiler(host);
    var typeChecker = undefined;
    if (config.typeCheck) {
        typeChecker = new type_checker_1.TypeChecker(host, _resolve, _fetch);
        return _resolve('ts', '')
            .then(function (moduleName) {
            return _resolve(host.getDefaultLibFileName(), moduleName);
        })
            .then(function (defaultLibAddress) {
            typeChecker.registerDeclarationFile(defaultLibAddress, true);
            return { transpiler: transpiler, typeChecker: typeChecker, host: host };
        });
    }
    else {
        return Promise.resolve({ transpiler: transpiler, typeChecker: typeChecker, host: host });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbImNyZWF0ZUZhY3RvcnkiLCJjcmVhdGVTZXJ2aWNlcyJdLCJtYXBwaW5ncyI6IkFBQ0EsSUFBWSxFQUFFLFdBQU0sWUFBWSxDQUFDLENBQUE7QUFDakMsdUJBQW1CLFVBQVUsQ0FBQyxDQUFBO0FBQzlCLDhCQUEyQixpQkFBaUIsQ0FBQyxDQUFBO0FBQzdDLDJCQUF5QixjQUFjLENBQUMsQ0FBQTtBQUN4Qyw2QkFBMEIsZ0JBQWdCLENBQUMsQ0FBQTtBQUMzQyw4QkFBMkIsaUJBQWlCLENBQUMsQ0FBQTtBQUM3QyxzQkFBc0MsU0FBUyxDQUFDLENBQUE7QUFFaEQsSUFBSSxNQUFNLEdBQUcsSUFBSSxnQkFBTSxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7QUFRMUMsdUJBQThCLE9BQXNCLEVBQUUsUUFBeUIsRUFBRSxNQUFxQjtJQUNyR0EsT0FBT0EsR0FBR0EsT0FBT0EsSUFBSUEsRUFBRUEsQ0FBQ0E7SUFFeEJBLEVBQUVBLENBQUNBLENBQUNBLE9BQU9BLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBO1FBQ3JCQSxJQUFJQSxRQUFRQSxHQUFHQSxDQUFDQSxPQUFPQSxDQUFDQSxRQUFRQSxLQUFLQSxJQUFJQSxDQUFDQSxHQUFHQSxlQUFlQSxHQUFHQSxPQUFPQSxDQUFDQSxRQUFrQkEsQ0FBQ0E7UUFFMUZBLE1BQU1BLENBQUNBLFFBQVFBLENBQUNBLFFBQVFBLENBQUNBO2FBQ3hCQSxJQUFJQSxDQUFDQSxVQUFBQSxlQUFlQTtZQUNwQkEsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZUFBZUEsQ0FBQ0E7aUJBQzVCQSxJQUFJQSxDQUFDQSxVQUFBQSxZQUFZQTtnQkFDakJBLE1BQU1BLENBQUNBLEVBQUNBLGlCQUFBQSxlQUFlQSxFQUFFQSxjQUFBQSxZQUFZQSxFQUFDQSxDQUFDQTtZQUN4Q0EsQ0FB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SUEsRUFBRUEsUUFBUUEsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFFdERBLE1BQU1BLENBQUNBLFFBQVFBLENBQUNBLElBQUlBLEVBQUVBLEVBQUVBLENBQUNBO2FBQ3RCQSxJQUFJQSxDQUFDQSxVQUFBQSxVQUFVQTtZQUNkQSxNQUFNQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxDQUFDQSxxQkFBcUJBLEVBQUVBLEVBQUVBLFVBQVVBLENBQUNBLENBQUFBO1FBQzNEQSxDQUFDQSxDQUFDQTthQUNEQSxJQUFJQSxDQUFDQSxVQUFBQSxpQkFBaUJBO1lBQ3RCQSxXQUFXQSxDQUFDQSx1QkFBdUJBLENBQUNBLGlCQUFpQkEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDN0RBLE1BQU1BLENBQUNBLEVBQUNBLFlBQUFBLFVBQVVBLEVBQUVBLGFBQUFBLFdBQVdBLEVBQUVBLE1BQUFBLElBQUlBLEVBQUNBLENBQUNBO1FBQ3hDQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUNOQSxDQUFDQTtJQUNEQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNMQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxFQUFDQSxZQUFBQSxVQUFVQSxFQUFFQSxhQUFBQSxXQUFXQSxFQUFFQSxNQUFBQSxJQUFJQSxFQUFDQSxDQUFDQSxDQUFDQTtJQUN6REEsQ0FBQ0E7QUFDRkEsQ0FBQ0EiLCJzb3VyY2VzQ29udGVudCI6WyIvKiAqL1xuaW1wb3J0ICogYXMgdHMgZnJvbSAndHlwZXNjcmlwdCc7XG5pbXBvcnQgTG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7Q29tcGlsZXJIb3N0fSBmcm9tICcuL2NvbXBpbGVyLWhvc3QnO1xuaW1wb3J0IHtUcmFuc3BpbGVyfSBmcm9tICcuL3RyYW5zcGlsZXInO1xuaW1wb3J0IHtUeXBlQ2hlY2tlcn0gZnJvbSAnLi90eXBlLWNoZWNrZXInO1xuaW1wb3J0IHtmb3JtYXRFcnJvcnN9IGZyb20gJy4vZm9ybWF0LWVycm9ycyc7XG5pbXBvcnQge2lzVHlwZXNjcmlwdERlY2xhcmF0aW9ufSBmcm9tIFwiLi91dGlsc1wiO1xuXG5sZXQgbG9nZ2VyID0gbmV3IExvZ2dlcih7IGRlYnVnOiBmYWxzZSB9KTtcblxuaW50ZXJmYWNlIEZhY3RvcnlPdXRwdXQge1xuXHQgaG9zdDogQ29tcGlsZXJIb3N0O1xuXHQgdHJhbnNwaWxlcjogVHJhbnNwaWxlcjtcblx0IHR5cGVDaGVja2VyOiBUeXBlQ2hlY2tlcjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUZhY3Rvcnkob3B0aW9uczogUGx1Z2luT3B0aW9ucywgX3Jlc29sdmU6IFJlc29sdmVGdW5jdGlvbiwgX2ZldGNoOiBGZXRjaEZ1bmN0aW9uKTogUHJvbWlzZTxGYWN0b3J5T3V0cHV0PiB7XG5cdG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuXG5cdGlmIChvcHRpb25zLnRzY29uZmlnKSB7XG5cdFx0IGxldCB0c2NvbmZpZyA9IChvcHRpb25zLnRzY29uZmlnID09PSB0cnVlKSA/IFwidHNjb25maWcuanNvblwiIDogb3B0aW9ucy50c2NvbmZpZyBhcyBzdHJpbmc7XG5cblx0XHQgcmV0dXJuIF9yZXNvbHZlKHRzY29uZmlnKVxuXHRcdFx0LnRoZW4odHNjb25maWdBZGRyZXNzID0+IHtcblx0XHRcdFx0cmV0dXJuIF9mZXRjaCh0c2NvbmZpZ0FkZHJlc3MpXG5cdFx0XHRcdFx0LnRoZW4odHNjb25maWdUZXh0ID0+IHtcblx0XHRcdFx0XHRcdHJldHVybiB7dHNjb25maWdBZGRyZXNzLCB0c2NvbmZpZ1RleHR9O1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0fSlcblx0XHRcdC50aGVuKCh7dHNjb25maWdBZGRyZXNzLCB0c2NvbmZpZ1RleHR9KSA9PiB7XG5cdFx0XHRcdGxldCB0czEgPSB0cyBhcyBhbnk7XG5cdFx0XHRcdGxldCByZXN1bHQgPSB0czEucGFyc2VDb25maWdGaWxlVGV4dCA/IHRzMS5wYXJzZUNvbmZpZ0ZpbGVUZXh0KHRzY29uZmlnQWRkcmVzcywgdHNjb25maWdUZXh0KSA6IHRzMS5wYXJzZUNvbmZpZ0ZpbGVUZXh0VG9Kc29uKHRzY29uZmlnQWRkcmVzcywgdHNjb25maWdUZXh0KTtcblxuXHRcdFx0XHRpZiAocmVzdWx0LmVycm9yKSB7XG5cdFx0XHRcdFx0Zm9ybWF0RXJyb3JzKFtyZXN1bHQuZXJyb3JdLCBsb2dnZXIpO1xuXHRcdFx0XHRcdHRocm93IG5ldyBFcnJvcihgZmFpbGVkIHRvIGxvYWQgdHNjb25maWcgZnJvbSAke3RzY29uZmlnQWRkcmVzc31gKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGxldCBjb25maWcgPSBPYmplY3QuYXNzaWduKHJlc3VsdC5jb25maWcuY29tcGlsZXJPcHRpb25zLCBvcHRpb25zKTtcblx0XHRcdFx0bGV0IGZpbGVzID0gcmVzdWx0LmNvbmZpZy5maWxlcyB8fCBbXTtcblxuXHRcdFx0XHRyZXR1cm4gY3JlYXRlU2VydmljZXMoY29uZmlnLCBfcmVzb2x2ZSwgX2ZldGNoKVxuXHRcdFx0XHRcdC50aGVuKHNlcnZpY2VzID0+IHtcblx0XHRcdFx0XHRcdGxldCByZXNvbHV0aW9ucyA9IGZpbGVzXG5cdFx0XHRcdFx0XHRcdC5maWx0ZXIoZmlsZW5hbWUgPT4gaXNUeXBlc2NyaXB0RGVjbGFyYXRpb24oZmlsZW5hbWUpKVxuXHRcdFx0XHRcdFx0XHQubWFwKGZpbGVuYW1lID0+IF9yZXNvbHZlKGZpbGVuYW1lLCB0c2NvbmZpZ0FkZHJlc3MpKTtcblxuXHRcdFx0XHRcdFx0cmV0dXJuIFByb21pc2UuYWxsPHN0cmluZz4ocmVzb2x1dGlvbnMpXG5cdFx0XHRcdFx0XHRcdC50aGVuKHJlc29sdmVkRmlsZXMgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdHJlc29sdmVkRmlsZXMuZm9yRWFjaChyZXNvbHZlZEZpbGUgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdFx0c2VydmljZXMudHlwZUNoZWNrZXIucmVnaXN0ZXJEZWNsYXJhdGlvbkZpbGUocmVzb2x2ZWRGaWxlLCBmYWxzZSk7XG5cdFx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRcdFx0cmV0dXJuIHNlcnZpY2VzO1xuXHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHR9KTtcblx0XHRcdH0pO1xuXHR9XG5cdGVsc2Uge1xuXHRcdHJldHVybiBjcmVhdGVTZXJ2aWNlcyhvcHRpb25zLCBfcmVzb2x2ZSwgX2ZldGNoKTtcblx0fVxufVxuXG5mdW5jdGlvbiBjcmVhdGVTZXJ2aWNlcyhjb25maWc6IFBsdWdpbk9wdGlvbnMsIF9yZXNvbHZlOiBSZXNvbHZlRnVuY3Rpb24sIF9mZXRjaDogRmV0Y2hGdW5jdGlvbik6IFByb21pc2U8RmFjdG9yeU91dHB1dD4ge1xuXHRsZXQgaG9zdCA9IG5ldyBDb21waWxlckhvc3QoY29uZmlnKTtcblx0bGV0IHRyYW5zcGlsZXIgPSBuZXcgVHJhbnNwaWxlcihob3N0KTtcblx0bGV0IHR5cGVDaGVja2VyID0gdW5kZWZpbmVkO1xuXG5cdGlmIChjb25maWcudHlwZUNoZWNrKSB7XG5cdFx0dHlwZUNoZWNrZXIgPSBuZXcgVHlwZUNoZWNrZXIoaG9zdCwgX3Jlc29sdmUsIF9mZXRjaCk7XG5cblx0XHRyZXR1cm4gX3Jlc29sdmUoJ3RzJywgJycpXG5cdFx0XHRcdC50aGVuKG1vZHVsZU5hbWUgPT4ge1xuXHRcdFx0XHRcdCByZXR1cm4gX3Jlc29sdmUoaG9zdC5nZXREZWZhdWx0TGliRmlsZU5hbWUoKSwgbW9kdWxlTmFtZSlcblx0XHRcdFx0fSlcblx0XHRcdFx0LnRoZW4oZGVmYXVsdExpYkFkZHJlc3MgPT4ge1xuXHRcdFx0XHRcdHR5cGVDaGVja2VyLnJlZ2lzdGVyRGVjbGFyYXRpb25GaWxlKGRlZmF1bHRMaWJBZGRyZXNzLCB0cnVlKTtcblx0XHRcdFx0XHRyZXR1cm4ge3RyYW5zcGlsZXIsIHR5cGVDaGVja2VyLCBob3N0fTtcblx0XHRcdFx0fSk7XG5cdH1cblx0ZWxzZSB7XG5cdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZSh7dHJhbnNwaWxlciwgdHlwZUNoZWNrZXIsIGhvc3R9KTtcblx0fVxufVxuIl19