var ts = require('typescript');
var logger_1 = require('./logger');
var utils_1 = require("./utils");
var compiler_host_1 = require("./compiler-host");
var logger = new logger_1.default({ debug: false });
var TypeChecker = (function () {
    function TypeChecker(host, resolve, fetch) {
        this._host = host;
        this._resolve = resolve;
        this._fetch = fetch;
        this._options = ts.clone(this._host.options);
        this._options.inlineSourceMap = false;
        this._options.sourceMap = false;
        this._options.declaration = false;
        this._options.isolatedModules = false;
        this._options.skipDefaultLibCheck = true;
        this._files = new Map();
        this._declarationFiles = [];
        this._typings = new Map();
    }
    TypeChecker.prototype.check = function (sourceName, source) {
        var file = this.registerFile(sourceName);
        this.registerSource(sourceName, source);
        return file.errors;
    };
    TypeChecker.prototype.registerDeclarationFile = function (sourceName, isDefaultLib) {
        var file = this.registerFile(sourceName, isDefaultLib);
        this._declarationFiles.push(file);
    };
    TypeChecker.prototype.registerFile = function (sourceName, isDefaultLib) {
        var _this = this;
        if (isDefaultLib === void 0) { isDefaultLib = false; }
        if (!this._files[sourceName]) {
            var source = new Deferred();
            if (utils_1.isTypescriptDeclaration(sourceName)) {
                this._fetch(sourceName)
                    .then(function (source) {
                    _this._host.addFile(sourceName, source, isDefaultLib);
                    _this.registerSource(sourceName, source);
                })
                    .catch(function (err) {
                    logger.error(err.message);
                });
            }
            var loaded = source.promise
                .then(function (source) { return _this.resolveDependencies(sourceName, source); })
                .then(function (depsMap) {
                _this._host.addResolutionMap(sourceName, depsMap);
                _this._files[sourceName].deps = Object.keys(depsMap)
                    .map(function (key) { return depsMap[key]; })
                    .filter(function (res) { return utils_1.isTypescript(res); })
                    .map(function (res) { return _this.registerFile(res); })
                    .concat(_this._declarationFiles);
            });
            var errors = loaded
                .then(function () { return _this.canEmit(_this._files[sourceName]); })
                .then(function () { return _this.getAllDiagnostics(_this._files[sourceName]); });
            this._files[sourceName] = {
                sourceName: sourceName,
                source: source,
                loaded: loaded,
                errors: errors,
                checked: false,
            };
        }
        return this._files[sourceName];
    };
    TypeChecker.prototype.registerSource = function (sourceName, source) {
        if (!this._files[sourceName])
            throw new Error(sourceName + " has not been registered");
        this._files[sourceName].source.resolve(source);
    };
    TypeChecker.prototype.resolveDependencies = function (sourceName, source) {
        var _this = this;
        var info = ts.preProcessFile(source, true);
        var resolvedReferences = info.referencedFiles
            .map(function (ref) { return _this.resolveReference(ref.fileName, sourceName); });
        var resolvedImports = info.importedFiles
            .map(function (imp) { return _this.resolveImport(imp.fileName, sourceName); });
        var refs = [].concat(info.referencedFiles).concat(info.importedFiles).map(function (pre) { return pre.fileName; });
        var deps = resolvedReferences.concat(resolvedImports);
        return Promise.all(deps)
            .then(function (resolved) {
            return refs.reduce(function (result, ref, idx) {
                result[ref] = resolved[idx];
                return result;
            }, {});
        });
    };
    TypeChecker.prototype.resolveReference = function (referenceName, sourceName) {
        if ((utils_1.isAmbient(referenceName) && !this._options.resolveAmbientRefs) || (referenceName.indexOf("/") === -1))
            referenceName = "./" + referenceName;
        return this._resolve(referenceName, sourceName);
    };
    TypeChecker.prototype.resolveImport = function (importName, sourceName) {
        var _this = this;
        if (utils_1.isRelative(importName) && utils_1.isTypescriptDeclaration(sourceName) && !utils_1.isTypescriptDeclaration(importName))
            importName = importName + ".d.ts";
        return this._resolve(importName, sourceName)
            .then(function (resolvedImport) {
            if (_this._options.resolveTypings && utils_1.isAmbientImport(importName) && utils_1.isJavaScript(resolvedImport) && !utils_1.isTypescriptDeclaration(sourceName)) {
                if (!_this._typings[resolvedImport]) {
                    _this._typings[resolvedImport] = _this.resolveTyping(importName, sourceName)
                        .then(function (resolvedTyping) {
                        return resolvedTyping ? resolvedTyping : resolvedImport;
                    });
                }
                return _this._typings[resolvedImport];
            }
            else {
                return resolvedImport;
            }
        });
    };
    TypeChecker.prototype.resolveTyping = function (importName, sourceName) {
        var _this = this;
        var packageName = importName.split(/\//)[0];
        return this._resolve(packageName, sourceName)
            .then(function (exported) {
            return exported.slice(0, -3) + "/package.json";
        })
            .then(function (address) {
            return _this._fetch(address)
                .then(function (packageText) {
                var typings = JSON.parse(packageText).typings;
                return typings ? _this._resolve(typings, address) : undefined;
            })
                .catch(function (err) {
                logger.warn("unable to resolve typings for " + importName + ", " + address + " could not be found");
                return undefined;
            });
        });
    };
    TypeChecker.prototype.canEmit = function (file, seen) {
        var _this = this;
        seen = seen || [];
        if (seen.indexOf(file) < 0) {
            seen.push(file);
            return file.loaded.then(function () { return Promise.all(file.deps.map(function (dep) { return _this.canEmit(dep, seen); })); });
        }
    };
    TypeChecker.prototype.accumulateDeps = function (file, result) {
        var _this = this;
        result = result || [];
        if (result.indexOf(file) < 0) {
            result.push(file);
            file.deps.forEach(function (dep) { return _this.accumulateDeps(dep, result); });
        }
        return result;
    };
    TypeChecker.prototype.getAllDiagnostics = function (file) {
        var _this = this;
        var deps = this.accumulateDeps(file);
        var filelist = deps.map(function (dep) { return dep.sourceName; }).concat([compiler_host_1.__HTML_MODULE__]);
        var program = ts.createProgram(filelist, this._options, this._host);
        return deps.reduce(function (diags, dep) {
            if (!dep.checked) {
                var sourceFile = _this._host.getSourceFile(dep.sourceName);
                diags = diags
                    .concat(program.getSyntacticDiagnostics(sourceFile))
                    .concat(program.getSemanticDiagnostics(sourceFile));
                dep.checked = true;
            }
            return diags;
        }, program.getGlobalDiagnostics());
    };
    return TypeChecker;
})();
exports.TypeChecker = TypeChecker;
var Deferred = (function () {
    function Deferred() {
        var _this = this;
        this.promise = new Promise(function (resolve, reject) {
            _this.resolve = resolve;
            _this.reject = reject;
        });
    }
    return Deferred;
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZS1jaGVja2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3R5cGUtY2hlY2tlci50cyJdLCJuYW1lcyI6WyJUeXBlQ2hlY2tlciIsIlR5cGVDaGVja2VyLmNvbnN0cnVjdG9yIiwiVHlwZUNoZWNrZXIuY2hlY2siLCJUeXBlQ2hlY2tlci5yZWdpc3RlckRlY2xhcmF0aW9uRmlsZSIsIlR5cGVDaGVja2VyLnJlZ2lzdGVyRmlsZSIsIlR5cGVDaGVja2VyLnJlZ2lzdGVyU291cmNlIiwiVHlwZUNoZWNrZXIucmVzb2x2ZURlcGVuZGVuY2llcyIsIlR5cGVDaGVja2VyLnJlc29sdmVSZWZlcmVuY2UiLCJUeXBlQ2hlY2tlci5yZXNvbHZlSW1wb3J0IiwiVHlwZUNoZWNrZXIucmVzb2x2ZVR5cGluZyIsIlR5cGVDaGVja2VyLmNhbkVtaXQiLCJUeXBlQ2hlY2tlci5hY2N1bXVsYXRlRGVwcyIsIlR5cGVDaGVja2VyLmdldEFsbERpYWdub3N0aWNzIiwiRGVmZXJyZWQiLCJEZWZlcnJlZC5jb25zdHJ1Y3RvciJdLCJtYXBwaW5ncyI6IkFBQ0EsSUFBWSxFQUFFLFdBQU0sWUFBWSxDQUFDLENBQUE7QUFDakMsdUJBQW1CLFVBQVUsQ0FBQyxDQUFBO0FBRzlCLHNCQUdrQyxTQUFTLENBQUMsQ0FBQTtBQUM1Qyw4QkFBOEIsaUJBQWlCLENBQUMsQ0FBQTtBQUVoRCxJQUFJLE1BQU0sR0FBRyxJQUFJLGdCQUFNLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztBQVcxQztJQVNDQSxxQkFBWUEsSUFBa0JBLEVBQUVBLE9BQXdCQSxFQUFFQSxLQUFvQkE7UUFDN0VDLElBQUlBLENBQUNBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBO1FBQ2xCQSxJQUFJQSxDQUFDQSxRQUFRQSxHQUFHQSxPQUFPQSxDQUFDQTtRQUN4QkEsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsS0FBS0EsQ0FBQ0E7UUFFaEJBLElBQUlBLENBQUNBLFFB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QUNBLENBQUNBO3FCQUNuREEsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0Esc0JBQXNCQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFFckRBLEdBQUdBLENBQUNBLE9BQU9BLEdBQUdBLElBQUlBLENBQUNBO1lBQ3BCQSxDQUFDQTtZQUNEQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQTtRQUNkQSxDQUFDQSxFQUFFQSxPQUFPQSxDQUFDQSxvQkFBb0JBLEVBQUVBLENBQUNBLENBQUNBO0lBQ3BDQSxDQUFDQTtJQUNGWixrQkFBQ0E7QUFBREEsQ0FBQ0EsQUExT0QsSUEwT0M7QUExT1ksbUJBQVcsY0EwT3ZCLENBQUE7QUFFRDtJQUtDYTtRQUxEQyxpQkFXQ0E7UUFMQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0EsSUFBSUEsT0FBT0EsQ0FBSUEsVUFBQ0EsT0FBT0EsRUFBRUEsTUFBTUE7WUFDN0NBLEtBQUlBLENBQUNBLE9BQU9BLEdBQUdBLE9BQU9BLENBQUNBO1lBQ3ZCQSxLQUFJQSxDQUFDQSxNQUFNQSxHQUFHQSxNQUFNQSxDQUFDQTtRQUN0QkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDSkEsQ0FBQ0E7SUFDRkQsZUFBQ0E7QUFBREEsQ0FBQ0EsQUFYRCxJQVdDIiwic291cmNlc0NvbnRlbnQiOlsiLyogKi9cbmltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xuaW1wb3J0IExvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQge0NvbXBpbGVySG9zdCwgQ29tYmluZWRPcHRpb25zfSBmcm9tICcuL2NvbXBpbGVyLWhvc3QnO1xuaW1wb3J0IHtmb3JtYXRFcnJvcnN9IGZyb20gJy4vZm9ybWF0LWVycm9ycyc7XG5pbXBvcnQge1xuXHRpc1R5cGVzY3JpcHQsIGlzVHlwZXNjcmlwdERlY2xhcmF0aW9uLFxuXHRpc0phdmFTY3JpcHQsIGlzUmVsYXRpdmUsXG5cdGlzQW1iaWVudCwgaXNBbWJpZW50SW1wb3J0fSBmcm9tIFwiLi91dGlsc1wiO1xuaW1wb3J0IHtfX0hUTUxfTU9EVUxFX199IGZyb20gXCIuL2NvbXBpbGVyLWhvc3RcIjtcblxubGV0IGxvZ2dlciA9IG5ldyBMb2dnZXIoeyBkZWJ1ZzogZmFsc2UgfSk7XG5cbmludGVyZmFjZSBGaWxlRW50cnkge1xuXHRzb3VyY2VOYW1lOiBzdHJpbmc7XG5cdHNvdXJjZTogRGVmZXJyZWQ8c3RyaW5nPjtcblx0ZGVwcz86IEZpbGVFbnRyeVtdO1xuXHRsb2FkZWQ6IFByb21pc2U8YW55Pjtcblx0ZXJyb3JzOiBQcm9taXNlPHRzLkRpYWdub3N0aWNbXT47XG5cdGNoZWNrZWQ6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBjbGFzcyBUeXBlQ2hlY2tlciB7XG5cdHByaXZhdGUgX2hvc3Q6IENvbXBpbGVySG9zdDtcblx0cHJpdmF0ZSBfcmVzb2x2ZTogUmVzb2x2ZUZ1bmN0aW9uO1xuXHRwcml2YXRlIF9mZXRjaDogRmV0Y2hGdW5jdGlvbjtcbiAgIHByaXZhdGUgX29wdGlvbnM6IENvbWJpbmVkT3B0aW9ucztcblx0cHJpdmF0ZSBfZmlsZXM6IE1hcDxzdHJpbmcsIEZpbGVFbnRyeT47XG5cdHByaXZhdGUgX2RlY2xhcmF0aW9uRmlsZXM6IEZpbGVFbnRyeVtdO1xuXHRwcml2YXRlIF90eXBpbmdzOiBNYXA8c3RyaW5nLCBzdHJpbmc+O1xuXG5cdGNvbnN0cnVjdG9yKGhvc3Q6IENvbXBpbGVySG9zdCwgcmVzb2x2ZTogUmVzb2x2ZUZ1bmN0aW9uLCBmZXRjaDogRmV0Y2hGdW5jdGlvbikge1xuXHRcdHRoaXMuX2hvc3QgPSBob3N0O1xuXHRcdHRoaXMuX3Jlc29sdmUgPSByZXNvbHZlO1xuXHRcdHRoaXMuX2ZldGNoID0gZmV0Y2g7XG5cbiAgICAgIHRoaXMuX29wdGlvbnMgPSAoPGFueT50cykuY2xvbmUodGhpcy5faG9zdC5vcHRpb25zKTtcblx0XHR0aGlzLl9vcHRpb25zLmlubGluZVNvdXJjZU1hcCA9IGZhbHNlO1xuXHRcdHRoaXMuX29wdGlvbnMuc291cmNlTWFwID0gZmFsc2U7XG5cdFx0dGhpcy5fb3B0aW9ucy5kZWNsYXJhdGlvbiA9IGZhbHNlO1xuXHRcdHRoaXMuX29wdGlvbnMuaXNvbGF0ZWRNb2R1bGVzID0gZmFsc2U7XG5cdFx0dGhpcy5fb3B0aW9ucy5za2lwRGVmYXVsdExpYkNoZWNrID0gdHJ1ZTsgLy8gZG9uJ3QgY2hlY2sgdGhlIGRlZmF1bHQgbGliIGZvciBiZXR0ZXIgcGVyZm9ybWFuY2VcblxuXHRcdC8vIG1hcCBvZiBhbGwgdHlwZXNjcmlwdCBmaWxlcyAtPiBmaWxlLWVudHJ5XG5cdFx0dGhpcy5fZmlsZXMgPSBuZXcgTWFwPHN0cmluZywgRmlsZUVudHJ5PigpO1xuXG5cdFx0Ly8gbGlzdCBvZiBhbGwgcmVnaXN0ZXJlZCBkZWNsYXJhdGlvbiBmaWxlc1xuXHRcdHRoaXMuX2RlY2xhcmF0aW9uRmlsZXMgPSBbXTtcblxuXHRcdC8vIG1hcCBvZiBleHRlcm5hbCBtb2R1bGVzIHRvIHRoZWlyIHR5cGluZ3Ncblx0XHR0aGlzLl90eXBpbmdzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcblx0fVxuXG5cdC8qXG5cdFx0cmV0dXJucyBhIHByb21pc2UgdG8gYW4gYXJyYXkgb2YgdHlwZXNjcmlwdCBlcnJvcnMgZm9yIHRoaXMgZmlsZVxuXHQqL1xuXHRwdWJsaWMgY2hlY2soc291cmNlTmFtZTogc3RyaW5nLCBzb3VyY2U6IHN0cmluZyk6IFByb21pc2U8dHMuRGlhZ25vc3RpY1tdPiB7XG5cdFx0dmFyIGZpbGUgPSB0aGlzLnJlZ2lzdGVyRmlsZShzb3VyY2VOYW1lKTtcblx0XHR0aGlzLnJlZ2lzdGVyU291cmNlKHNvdXJjZU5hbWUsIHNvdXJjZSk7XG5cdFx0cmV0dXJuIGZpbGUuZXJyb3JzO1xuXHR9XG5cblx0Lypcblx0XHRyZWdpc3RlciBkZWNsYXJhdGlvbiBmaWxlcyBmcm9tIGNvbmZpZ1xuXHQqL1xuXHRwdWJsaWMgcmVnaXN0ZXJEZWNsYXJhdGlvbkZpbGUoc291cmNlTmFtZTogc3RyaW5nLCBpc0RlZmF1bHRMaWI6IGJvb2xlYW4pIHtcblx0XHRsZXQgZmlsZSA9IHRoaXMucmVnaXN0ZXJGaWxlKHNvdXJjZU5hbWUsIGlzRGVmYXVsdExpYik7XG5cdFx0dGhpcy5fZGVjbGFyYXRpb25GaWxlcy5wdXNoKGZpbGUpO1xuXHR9XG5cblx0LyogcHJpdmF0ZSBtZXRob2RzICovXG5cblx0cHJpdmF0ZSByZWdpc3RlckZpbGUoc291cmNlTmFtZTogc3RyaW5nLCBpc0RlZmF1bHRMaWI6IGJvb2xlYW4gPSBmYWxzZSk6IEZpbGVFbnRyeSB7XG5cdFx0aWYgKCF0aGlzLl9maWxlc1tzb3VyY2VOYW1lXSkge1xuXHRcdFx0bGV0IHNvdXJjZSA9IG5ldyBEZWZlcnJlZDxzdHJpbmc+KCk7XG5cblx0XHRcdC8qIHdlIG5lZWQgdG8gZmV0Y2ggZGVjbGFyYXRpb24gZmlsZXMgb3Vyc2VsdmVzICovXG5cdFx0XHRpZiAoaXNUeXBlc2NyaXB0RGVjbGFyYXRpb24oc291cmNlTmFtZSkpIHtcblx0XHRcdFx0dGhpcy5fZmV0Y2goc291cmNlTmFtZSlcblx0XHRcdFx0XHQudGhlbigoc291cmNlKSA9PiB7XG5cdFx0XHRcdFx0XHR0aGlzLl9ob3N0LmFkZEZpbGUoc291cmNlTmFtZSwgc291cmNlLCBpc0RlZmF1bHRMaWIpO1xuXHRcdFx0XHRcdFx0dGhpcy5yZWdpc3RlclNvdXJjZShzb3VyY2VOYW1lLCBzb3VyY2UpO1xuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0LmNhdGNoKGVyciA9PiB7XG5cdFx0XHRcdFx0XHRsb2dnZXIuZXJyb3IoZXJyLm1lc3NhZ2UpO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0fVxuXG5cdFx0XHQvKiBsb2FkZWQgaXMgYSBwcm9taXNlIHJlc29sdmVkIHdoZW4gdGhlIHNvdXJjZSBoYXMgYmVlbiBhZGRlZCB0byB0aGVcblx0XHRcdFx0aG9zdCBhbmQgYWxsIHRoZSBkZXBlbmRlbmNpZXMgdXNlZCBieSB0aGlzIGZpbGUgaGF2ZSBiZWVuIHJlc29sdmVkICovXG5cdFx0XHRsZXQgbG9hZGVkID0gc291cmNlLnByb21pc2Vcblx0XHRcdFx0LnRoZW4oKHNvdXJjZSkgPT4gdGhpcy5yZXNvbHZlRGVwZW5kZW5jaWVzKHNvdXJjZU5hbWUsIHNvdXJjZSkpXG5cdFx0XHRcdC50aGVuKChkZXBzTWFwKSA9PiB7XG5cdFx0XHRcdFx0dGhpcy5faG9zdC5hZGRSZXNvbHV0aW9uTWFwKHNvdXJjZU5hbWUsIGRlcHNNYXApO1xuXG5cdFx0XHRcdFx0dGhpcy5fZmlsZXNbc291cmNlTmFtZV0uZGVwcyA9IE9iamVjdC5rZXlzKGRlcHNNYXApXG5cdFx0XHRcdFx0XHQubWFwKChrZXkpID0+IGRlcHNNYXBba2V5XSlcblx0XHRcdFx0XHRcdC5maWx0ZXIoKHJlcykgPT4gaXNUeXBlc2NyaXB0KHJlcykpIC8vIGlnbm9yZSBlLmcuIGpzLCBjc3MgZmlsZXNcblx0XHRcdFx0XHRcdC5tYXAoKHJlcykgPT4gdGhpcy5yZWdpc3RlckZpbGUocmVzKSlcblx0XHRcdFx0XHRcdC5jb25jYXQodGhpcy5fZGVjbGFyYXRpb25GaWxlcyk7XG5cdFx0XHRcdH0pO1xuXG5cdFx0XHQvKiBlcnJvcnMgaXMgYSBwcm9taXNlIHRvIHRoZSBjb21waWxhdGlvbiByZXN1bHRzICovXG5cdFx0XHRsZXQgZXJyb3JzID0gbG9hZGVkXG5cdFx0XHRcdC50aGVuKCgpID0+IHRoaXMuY2FuRW1pdCh0aGlzLl9maWxlc1tzb3VyY2VOYW1lXSkpXG5cdFx0XHRcdC50aGVuKCgpID0+IHRoaXMuZ2V0QWxsRGlhZ25vc3RpY3ModGhpcy5fZmlsZXNbc291cmNlTmFtZV0pKTtcblxuXHRcdFx0dGhpcy5fZmlsZXNbc291cmNlTmFtZV0gPSB7XG5cdFx0XHRcdHNvdXJjZU5hbWUsXG5cdFx0XHRcdHNvdXJjZSxcblx0XHRcdFx0bG9hZGVkLFxuXHRcdFx0XHRlcnJvcnMsXG5cdFx0XHRcdGNoZWNrZWQ6IGZhbHNlLFxuXHRcdFx0fTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5fZmlsZXNbc291cmNlTmFtZV07XG5cdH1cblxuXHRwcml2YXRlIHJlZ2lzdGVyU291cmNlKHNvdXJjZU5hbWU6IHN0cmluZywgc291cmNlOiBzdHJpbmcpIHtcblx0XHRpZiAoIXRoaXMuX2ZpbGVzW3NvdXJjZU5hbWVdKVxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGAke3NvdXJjZU5hbWV9IGhhcyBub3QgYmVlbiByZWdpc3RlcmVkYCk7XG5cblx0XHR0aGlzLl9maWxlc1tzb3VyY2VOYW1lXS5zb3VyY2UucmVzb2x2ZShzb3VyY2UpO1xuXHR9XG5cblx0Lypcblx0XHRwcm9jZXNzIHRoZSBzb3VyY2UgdG8gZ2V0IGl0cyBkZXBlbmRlbmNpZXMgYW5kIHJlc29sdmUgYW5kIHJlZ2lzdGVyIHRoZW1cblx0XHRyZXR1cm5zIGEgcHJvbWlzZSB0byB0aGUgbGlzdCBvZiByZWdpc3RlcmVkIGRlcGVuZGVuY3kgZmlsZXNcblx0Ki9cblx0cHJpdmF0ZSByZXNvbHZlRGVwZW5kZW5jaWVzKHNvdXJjZU5hbWU6IHN0cmluZywgc291cmNlOiBzdHJpbmcpOiBQcm9taXNlPE1hcDxzdHJpbmcsIHN0cmluZz4+IHtcblx0XHRsZXQgaW5mbyA9IHRzLnByZVByb2Nlc3NGaWxlKHNvdXJjZSwgdHJ1ZSk7XG5cblx0XHQvKiBidWlsZCB0aGUgbGlzdCBvZiBmaWxlIHJlc29sdXRpb25zICovXG5cdFx0LyogcmVmZXJlbmNlcyBmaXJzdCAqL1xuXHRcdGxldCByZXNvbHZlZFJlZmVyZW5jZXMgPSBpbmZvLnJlZmVyZW5jZWRGaWxlc1xuXHRcdFx0Lm1hcCgocmVmKSA9PiB0aGlzLnJlc29sdmVSZWZlcmVuY2UocmVmLmZpbGVOYW1lLCBzb3VyY2VOYW1lKSk7XG5cblx0XHRsZXQgcmVzb2x2ZWRJbXBvcnRzID0gaW5mby5pbXBvcnRlZEZpbGVzXG5cdFx0XHQubWFwKChpbXApID0+IHRoaXMucmVzb2x2ZUltcG9ydChpbXAuZmlsZU5hbWUsIHNvdXJjZU5hbWUpKTtcblxuXHRcdGxldCByZWZzID0gW10uY29uY2F0KGluZm8ucmVmZXJlbmNlZEZpbGVzKS5jb25jYXQoaW5mby5pbXBvcnRlZEZpbGVzKS5tYXAocHJlID0+IHByZS5maWxlTmFtZSk7XG5cdFx0bGV0IGRlcHMgPSByZXNvbHZlZFJlZmVyZW5jZXMuY29uY2F0KHJlc29sdmVkSW1wb3J0cyk7XG5cblx0XHQvKiBhbmQgY29udmVydCB0byBwcm9taXNlIHRvIGEgbWFwIG9mIGxvY2FsIHJlZmVyZW5jZSB0byByZXNvbHZlZCBkZXBlbmRlbmN5ICovXG5cdFx0cmV0dXJuIFByb21pc2UuYWxsKGRlcHMpXG5cdFx0XHQudGhlbigocmVzb2x2ZWQpID0+IHtcblx0XHRcdFx0cmV0dXJuIHJlZnMucmVkdWNlKChyZXN1bHQsIHJlZiwgaWR4KSA9PiB7XG5cdFx0XHRcdFx0cmVzdWx0W3JlZl0gPSByZXNvbHZlZFtpZHhdO1xuXHRcdFx0XHRcdHJldHVybiByZXN1bHQ7XG5cdFx0XHRcdH0sIHt9KTtcblx0XHRcdH0pO1xuXHR9XG5cblx0cHJpdmF0ZSByZXNvbHZlUmVmZXJlbmNlKHJlZmVyZW5jZU5hbWU6IHN0cmluZywgc291cmNlTmFtZTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcblx0XHRpZiAoKGlzQW1iaWVudChyZWZlcmVuY2VOYW1lKSAmJiAhdGhpcy5fb3B0aW9ucy5yZXNvbHZlQW1iaWVudFJlZnMpIHx8IChyZWZlcmVuY2VOYW1lLmluZGV4T2YoXCIvXCIpID09PSAtMSkpXG5cdFx0XHRyZWZlcmVuY2VOYW1lID0gXCIuL1wiICsgcmVmZXJlbmNlTmFtZTtcblxuXHRcdHJldHVybiB0aGlzLl9yZXNvbHZlKHJlZmVyZW5jZU5hbWUsIHNvdXJjZU5hbWUpO1xuXHR9XG5cblx0cHJpdmF0ZSByZXNvbHZlSW1wb3J0KGltcG9ydE5hbWU6IHN0cmluZywgc291cmNlTmFtZTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcblx0XHRpZiAoaXNSZWxhdGl2ZShpbXBvcnROYW1lKSAmJiAgaXNUeXBlc2NyaXB0RGVjbGFyYXRpb24oc291cmNlTmFtZSkgJiYgIWlzVHlwZXNjcmlwdERlY2xhcmF0aW9uKGltcG9ydE5hbWUpKVxuXHRcdFx0aW1wb3J0TmFtZSA9IGltcG9ydE5hbWUgKyBcIi5kLnRzXCI7XG5cblx0XHRyZXR1cm4gdGhpcy5fcmVzb2x2ZShpbXBvcnROYW1lLCBzb3VyY2VOYW1lKVxuXHRcdFx0LnRoZW4ocmVzb2x2ZWRJbXBvcnQgPT4ge1xuXHRcdFx0ICBcdGlmICh0aGlzLl9vcHRpb25zLnJlc29sdmVUeXBpbmdzICYmIGlzQW1iaWVudEltcG9ydChpbXBvcnROYW1lKSAmJiBpc0phdmFTY3JpcHQocmVzb2x2ZWRJbXBvcnQpICYmICFpc1R5cGVzY3JpcHREZWNsYXJhdGlvbihzb3VyY2VOYW1lKSkge1xuXHRcdFx0ICBcdFx0aWYgKCF0aGlzLl90eXBpbmdzW3Jlc29sdmVkSW1wb3J0XSkge1xuXHRcdFx0XHRcdFx0dGhpcy5fdHlwaW5nc1tyZXNvbHZlZEltcG9ydF0gPSB0aGlzLnJlc29sdmVUeXBpbmcoaW1wb3J0TmFtZSwgc291cmNlTmFtZSlcblx0XHRcdFx0XHRcdFx0LnRoZW4ocmVzb2x2ZWRUeXBpbmcgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdHJldHVybiByZXNvbHZlZFR5cGluZyA/IHJlc29sdmVkVHlwaW5nIDogcmVzb2x2ZWRJbXBvcnQ7XG5cdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdHJldHVybiB0aGlzLl90eXBpbmdzW3Jlc29sdmVkSW1wb3J0XTtcblx0XHRcdCAgXHR9XG5cdFx0XHQgIFx0ZWxzZSB7XG5cdFx0XHQgIFx0XHRyZXR1cm4gcmVzb2x2ZWRJbXBvcnQ7XG5cdFx0XHQgIFx0fVxuICBcdFx0XHR9KTtcblx0fVxuXG5cdHByaXZhdGUgcmVzb2x2ZVR5cGluZyhpbXBvcnROYW1lOiBzdHJpbmcsIHNvdXJjZU5hbWU6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG5cdFx0Ly8gd2UgY2FuIG9ubHkgc3VwcG9ydCBwYWNrYWdlcyByZWdpc3RlcmVkIHdpdGhvdXQgYSBzbGFzaCBpbiB0aGVtXG5cdFx0bGV0IHBhY2thZ2VOYW1lID0gaW1wb3J0TmFtZS5zcGxpdCgvXFwvLylbMF07XG5cblx0XHRyZXR1cm4gdGhpcy5fcmVzb2x2ZShwYWNrYWdlTmFtZSwgc291cmNlTmFtZSlcblx0XHRcdC50aGVuKGV4cG9ydGVkID0+IHtcblx0XHRcdFx0cmV0dXJuIGV4cG9ydGVkLnNsaWNlKDAsIC0zKSArIFwiL3BhY2thZ2UuanNvblwiO1xuXHRcdFx0fSlcblx0XHRcdC50aGVuKGFkZHJlc3MgPT4ge1xuXHRcdFx0XHRyZXR1cm4gdGhpcy5fZmV0Y2goYWRkcmVzcylcblx0XHRcdFx0XHQudGhlbihwYWNrYWdlVGV4dCA9PiB7XG5cdFx0XHRcdFx0XHRsZXQgdHlwaW5ncyA9IEpTT04ucGFyc2UocGFja2FnZVRleHQpLnR5cGluZ3M7XG5cdFx0XHRcdFx0XHRyZXR1cm4gdHlwaW5ncyA/IHRoaXMuX3Jlc29sdmUodHlwaW5ncywgYWRkcmVzcykgOiB1bmRlZmluZWQ7XG5cdFx0XHRcdFx0fSlcblx0XHRcdFx0XHQuY2F0Y2goZXJyID0+IHtcblx0XHRcdFx0XHRcdGxvZ2dlci53YXJuKGB1bmFibGUgdG8gcmVzb2x2ZSB0eXBpbmdzIGZvciAke2ltcG9ydE5hbWV9LCAke2FkZHJlc3N9IGNvdWxkIG5vdCBiZSBmb3VuZGApO1xuXHRcdFx0XHRcdFx0cmV0dXJuIHVuZGVmaW5lZDtcblx0XHRcdFx0XHR9KTtcblx0XHRcdH0pO1xuXHR9XG5cblx0Lypcblx0XHRyZXR1cm5zIHByb21pc2UgcmVzb2x2ZWQgd2hlbiBmaWxlIGNhbiBiZSBlbWl0dGVkXG5cdCovXG5cdHByaXZhdGUgY2FuRW1pdChmaWxlOiBGaWxlRW50cnksIHNlZW4/OiBGaWxlRW50cnlbXSk6IFByb21pc2U8YW55PiB7XG5cdFx0LyogYXZvaWQgY2lyY3VsYXIgcmVmZXJlbmNlcyAqL1xuXHRcdHNlZW4gPSBzZWVuIHx8IFtdO1xuXG5cdFx0aWYgKHNlZW4uaW5kZXhPZihmaWxlKSA8IDApIHtcblx0XHRcdHNlZW4ucHVzaChmaWxlKTtcblxuXHRcdFx0cmV0dXJuIGZpbGUubG9hZGVkLnRoZW4oKCkgPT4gUHJvbWlzZS5hbGwoZmlsZS5kZXBzLm1hcCgoZGVwKSA9PiB0aGlzLmNhbkVtaXQoZGVwLCBzZWVuKSkpKTtcblx0XHR9XG5cdH1cblxuXHQvKlxuXHRcdFJldHVybnMgYSBmbGF0dGVuZWQgbGlzdCBvZiB0aGUgZGVwZW5kZW5jeSB0cmVlIGZvciB0aGlzIGZpbGUuXG5cdCovXG5cdHByaXZhdGUgYWNjdW11bGF0ZURlcHMoZmlsZTogRmlsZUVudHJ5LCByZXN1bHQ/OiBGaWxlRW50cnlbXSk6IEZpbGVFbnRyeVtdIHtcblx0XHRyZXN1bHQgPSByZXN1bHQgfHwgW107XG5cblx0XHRpZiAocmVzdWx0LmluZGV4T2YoZmlsZSkgPCAwKSB7XG5cdFx0XHRyZXN1bHQucHVzaChmaWxlKTtcblx0XHRcdGZpbGUuZGVwcy5mb3JFYWNoKChkZXApID0+IHRoaXMuYWNjdW11bGF0ZURlcHMoZGVwLCByZXN1bHQpKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gcmVzdWx0O1xuXHR9XG5cblx0Lypcblx0XHRSZXR1cm5zIHRoZSBkaWFnbm9zdGljcyBmb3IgdGhpcyBmaWxlIGFuZCBhbnkgZmlsZXMgd2hpY2ggaXQgdXNlcy5cblx0XHRFYWNoIGZpbGUgaXMgb25seSBjaGVja2VkIG9uY2UuXG5cdCovXG5cdHByaXZhdGUgZ2V0QWxsRGlhZ25vc3RpY3MoZmlsZTogRmlsZUVudHJ5KTogdHMuRGlhZ25vc3RpY1tdIHtcblx0XHRsZXQgZGVwcyA9IHRoaXMuYWNjdW11bGF0ZURlcHMoZmlsZSk7XG5cblx0XHQvLyBoYWNrIHRvIHN1cHBvcnQgaHRtbCBpbXBvcnRzXG5cdFx0bGV0IGZpbGVsaXN0ID0gZGVwcy5tYXAoKGRlcCkgPT4gZGVwLnNvdXJjZU5hbWUpLmNvbmNhdChbX19IVE1MX01PRFVMRV9fXSk7XG5cdFx0bGV0IHByb2dyYW0gPSB0cy5jcmVhdGVQcm9ncmFtKGZpbGVsaXN0LCB0aGlzLl9vcHRpb25zLCB0aGlzLl9ob3N0KTtcblxuXHRcdHJldHVybiBkZXBzLnJlZHVjZSgoZGlhZ3MsIGRlcCkgPT4ge1xuXHRcdFx0aWYgKCFkZXAuY2hlY2tlZCkge1xuXHRcdFx0XHRsZXQgc291cmNlRmlsZSA9IHRoaXMuX2hvc3QuZ2V0U291cmNlRmlsZShkZXAuc291cmNlTmFtZSk7XG5cblx0XHRcdFx0ZGlhZ3MgPSBkaWFnc1xuXHRcdFx0XHRcdC5jb25jYXQocHJvZ3JhbS5nZXRTeW50YWN0aWNEaWFnbm9zdGljcyhzb3VyY2VGaWxlKSlcblx0XHRcdFx0XHQuY29uY2F0KHByb2dyYW0uZ2V0U2VtYW50aWNEaWFnbm9zdGljcyhzb3VyY2VGaWxlKSk7XG5cblx0XHRcdFx0ZGVwLmNoZWNrZWQgPSB0cnVlO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIGRpYWdzO1xuXHRcdH0sIHByb2dyYW0uZ2V0R2xvYmFsRGlhZ25vc3RpY3MoKSk7XG5cdH1cbn1cblxuY2xhc3MgRGVmZXJyZWQ8VD4ge1xuXHRwdWJsaWMgcmVzb2x2ZTogKHJlc3VsdDogVCkgPT4gdm9pZDtcblx0cHVibGljIHJlamVjdDogKGVycjogRXJyb3IpID0+IHZvaWQ7XG5cdHB1YmxpYyBwcm9taXNlOiBQcm9taXNlPFQ+O1xuXG5cdGNvbnN0cnVjdG9yKCkge1xuXHRcdHRoaXMucHJvbWlzZSA9IG5ldyBQcm9taXNlPFQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdHRoaXMucmVzb2x2ZSA9IHJlc29sdmU7XG5cdFx0XHR0aGlzLnJlamVjdCA9IHJlamVjdDtcblx0XHR9KTtcblx0fVxufVxuIl19