System.register(['typescript', './logger', './utils', "./compiler-host"], function(exports_1) {
    var ts, logger_1, utils_1, compiler_host_1;
    var logger, TypeChecker;
    return {
        setters:[
            function (ts_1) {
                ts = ts_1;
            },
            function (logger_1_1) {
                logger_1 = logger_1_1;
            },
            function (utils_1_1) {
                utils_1 = utils_1_1;
            },
            function (compiler_host_1_1) {
                compiler_host_1 = compiler_host_1_1;
            }],
        execute: function() {
            logger = new logger_1.default({ debug: false });
            TypeChecker = (function () {
                function TypeChecker(host) {
                    this._host = host;
                    this._options = ts.clone(this._host.options);
                    this._options.inlineSourceMap = false;
                    this._options.sourceMap = false;
                    this._options.declaration = false;
                    this._options.isolatedModules = false;
                    this._options.skipDefaultLibCheck = true;
                }
                TypeChecker.prototype.check = function () {
                    var candidates = this.getCandidates();
                    if (candidates.some(function (candidate) { return candidate.checkable; }))
                        return this.getAllDiagnostics(candidates);
                    else
                        return [];
                };
                TypeChecker.prototype.forceCheck = function () {
                    var files = this._host.getAllFiles();
                    var unchecked = files.filter(function (file) { return !file.checked; });
                    var errored = files.filter(function (file) { return file.checked && utils_1.hasError(file.errors); });
                    if ((errored.length > 0) || (unchecked.length > 0)) {
                        return [{
                                file: undefined,
                                start: undefined,
                                length: undefined,
                                code: 9999,
                                category: ts.DiagnosticCategory.Error,
                                messageText: "compilation failed [" + files.length + " files, " + errored.length + " errored, " + unchecked.length + " unchecked]"
                            }];
                    }
                    return [];
                };
                TypeChecker.prototype.getCandidates = function () {
                    var _this = this;
                    var candidates = this._host.getAllFiles()
                        .filter(function (file) { return file.fileName != compiler_host_1.__HTML_MODULE__; })
                        .map(function (file) { return ({
                        name: file.fileName,
                        file: file,
                        seen: false,
                        resolved: !!file.dependencies,
                        checkable: undefined,
                        deps: file.dependencies && file.dependencies.list
                    }); });
                    var candidatesMap = candidates.reduce(function (result, candidate) {
                        result[candidate.name] = candidate;
                        return result;
                    }, {});
                    candidates.forEach(function (candidate) { return candidate.checkable = _this.isCheckable(candidate, candidatesMap); });
                    return candidates;
                };
                TypeChecker.prototype.isCheckable = function (candidate, candidatesMap) {
                    var _this = this;
                    if (!candidate)
                        return false;
                    else {
                        if (!candidate.seen) {
                            candidate.seen = true;
                            candidate.checkable = candidate.resolved && candidate.deps.every(function (dep) { return _this.isCheckable(candidatesMap[dep], candidatesMap); });
                        }
                        return (candidate.checkable !== false);
                    }
                };
                TypeChecker.prototype.getAllDiagnostics = function (candidates) {
                    var filelist = candidates.map(function (dep) { return dep.name; }).concat([compiler_host_1.__HTML_MODULE__]);
                    var program = ts.createProgram(filelist, this._options, this._host);
                    return candidates.reduce(function (errors, candidate) {
                        if (candidate.checkable && !candidate.file.checked) {
                            if (!candidate.file.isLibFile) {
                                errors = errors
                                    .concat(program.getSyntacticDiagnostics(candidate.file))
                                    .concat(program.getSemanticDiagnostics(candidate.file));
                            }
                            candidate.file.errors = errors;
                            candidate.file.checked = true;
                        }
                        return errors;
                    }, program.getGlobalDiagnostics());
                };
                return TypeChecker;
            })();
            exports_1("TypeChecker", TypeChecker);
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZS1jaGVja2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3R5cGUtY2hlY2tlci50cyJdLCJuYW1lcyI6WyJUeXBlQ2hlY2tlciIsIlR5cGVDaGVja2VyLmNvbnN0cnVjdG9yIiwiVHlwZUNoZWNrZXIuY2hlY2siLCJUeXBlQ2hlY2tlci5mb3JjZUNoZWNrIiwiVHlwZUNoZWNrZXIuZ2V0Q2FuZGlkYXRlcyIsIlR5cGVDaGVja2VyLmlzQ2hlY2thYmxlIiwiVHlwZUNoZWNrZXIuZ2V0QWxsRGlhZ25vc3RpY3MiXSwibWFwcGluZ3MiOiI7O1FBT00sTUFBTTs7Ozs7Ozs7Ozs7Ozs7OztZQUFOLE1BQU0sR0FBRyxJQUFJLGdCQUFNLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQWE1QztnQkFJQ0EscUJBQVlBLElBQWtCQTtvQkFDN0JDLElBQUlBLENBQUNBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBO29CQUVkQSxJQUFJQSxDQUFDQSxRQUFRQSxHQUFTQSxFQUFHQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtvQkFDeERBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLGVBQWVBLEdBQUdBLEtBQUtBLENBQUNBO29CQUN0Q0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsU0FBU0EsR0FBR0EsS0FBS0EsQ0FBQ0E7b0JBQ2hDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxXQUFXQSxHQUFHQSxLQUFLQSxDQUFDQTtvQkFDbENBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLGVBQWVBLEdBQUdBLEtBQUtBLENBQUNBO29CQUN0Q0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsbUJBQW1CQSxHQUFHQSxJQUFJQSxDQUFDQTtnQkFDMUNBLENBQUNBO2dCQUtNRCwyQkFBS0EsR0FBWkE7b0JBQ0tFLElBQU1BLFVBQVVBLEdBQUdBLElBQUlBLENBQUNBLGFB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VUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsVUFBQ0EsR0FBR0EsSUFBS0EsT0FBQUEsR0FBR0EsQ0FBQ0EsSUFBSUEsRUFBUkEsQ0FBUUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsK0JBQWVBLENBQUNBLENBQUNBLENBQUNBO29CQUMvRUEsSUFBSUEsT0FBT0EsR0FBR0EsRUFBRUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsUUFBUUEsRUFBRUEsSUFBSUEsQ0FBQ0EsUUFBUUEsRUFBRUEsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7b0JBRXBFQSxNQUFNQSxDQUFDQSxVQUFVQSxDQUFDQSxNQUFNQSxDQUFDQSxVQUFDQSxNQUFNQSxFQUFFQSxTQUFTQTt3QkFDMUNBLEVBQUVBLENBQUNBLENBQUNBLFNBQVNBLENBQUNBLFNBQVNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBOzRCQUM1Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0NBQzdCQSxNQUFNQSxHQUFHQSxNQUFNQTtxQ0FDWEEsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsdUJBQXVCQSxDQUFDQSxTQUFTQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtxQ0FDdkRBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBLHNCQUFzQkEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7NEJBQzlEQSxDQUFDQTs0QkFDREEsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsTUFBTUEsQ0FBQ0E7NEJBQ3ZDQSxTQUFTQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxHQUFHQSxJQUFJQSxDQUFDQTt3QkFDL0JBLENBQUNBO3dCQUNEQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQTtvQkFDZkEsQ0FBQ0EsRUFBRUEsT0FBT0EsQ0FBQ0Esb0JBQW9CQSxFQUFFQSxDQUFDQSxDQUFDQTtnQkFDcENBLENBQUNBO2dCQUNGTixrQkFBQ0E7WUFBREEsQ0FBQ0EsQUF4R0QsSUF3R0M7WUF4R0QscUNBd0dDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKiAqL1xuaW1wb3J0ICogYXMgdHMgZnJvbSAndHlwZXNjcmlwdCc7XG5pbXBvcnQgTG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7aGFzRXJyb3J9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHtDb21waWxlckhvc3QsIENvbWJpbmVkT3B0aW9ucywgU291cmNlRmlsZX0gZnJvbSAnLi9jb21waWxlci1ob3N0JztcbmltcG9ydCB7X19IVE1MX01PRFVMRV9ffSBmcm9tIFwiLi9jb21waWxlci1ob3N0XCI7XG5cbmNvbnN0IGxvZ2dlciA9IG5ldyBMb2dnZXIoeyBkZWJ1ZzogZmFsc2UgfSk7XG5cbnR5cGUgQ2FuZGlkYXRlID0ge1xuICAgbmFtZTogc3RyaW5nO1xuICAgZmlsZTogU291cmNlRmlsZTsgICBcbiAgIHNlZW46IGJvb2xlYW47XG4gICByZXNvbHZlZDogYm9vbGVhbjtcbiAgIGRlcHM6IHN0cmluZ1tdO1xuICAgY2hlY2thYmxlOiBib29sZWFuO1xufVxuXG50eXBlIENhbmRpZGF0ZU1hcCA9IHsgW3M6IHN0cmluZ106IENhbmRpZGF0ZSB9O1xuXG5leHBvcnQgY2xhc3MgVHlwZUNoZWNrZXIge1xuXHRwcml2YXRlIF9ob3N0OiBDb21waWxlckhvc3Q7XG4gICBwcml2YXRlIF9vcHRpb25zOiBDb21iaW5lZE9wdGlvbnM7XG5cblx0Y29uc3RydWN0b3IoaG9zdDogQ29tcGlsZXJIb3N0KSB7XG5cdFx0dGhpcy5faG9zdCA9IGhvc3Q7XG5cbiAgICAgIHRoaXMuX29wdGlvbnMgPSAoPGFueT50cykuY2xvbmUodGhpcy5faG9zdC5vcHRpb25zKTtcblx0XHR0aGlzLl9vcHRpb25zLmlubGluZVNvdXJjZU1hcCA9IGZhbHNlO1xuXHRcdHRoaXMuX29wdGlvbnMuc291cmNlTWFwID0gZmFsc2U7XG5cdFx0dGhpcy5fb3B0aW9ucy5kZWNsYXJhdGlvbiA9IGZhbHNlO1xuXHRcdHRoaXMuX29wdGlvbnMuaXNvbGF0ZWRNb2R1bGVzID0gZmFsc2U7XG5cdFx0dGhpcy5fb3B0aW9ucy5za2lwRGVmYXVsdExpYkNoZWNrID0gdHJ1ZTsgLy8gZG9uJ3QgY2hlY2sgdGhlIGRlZmF1bHQgbGliIGZvciBiZXR0ZXIgcGVyZm9ybWFuY2Vcblx0fVxuXG5cdC8qXG5cdFx0cmV0dXJucyBhIHByb21pc2UgdG8gYW4gYXJyYXkgb2YgdHlwZXNjcmlwdCBlcnJvcnMgZm9yIHRoaXMgZmlsZVxuXHQqL1xuXHRwdWJsaWMgY2hlY2soKTogdHMuRGlhZ25vc3RpY1tdIHsgICAgICAgICBcbiAgICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSB0aGlzLmdldENhbmRpZGF0ZXMoKTtcbiAgICAgIGlmIChjYW5kaWRhdGVzLnNvbWUoY2FuZGlkYXRlID0+IGNhbmRpZGF0ZS5jaGVja2FibGUpKSAgICAgICAgICAgIFxuICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QWxsRGlhZ25vc3RpY3MoY2FuZGlkYXRlcyk7IFxuICAgICAgZWxzZVxuICAgICAgICAgcmV0dXJuIFtdO1xuXHR9XG5cblx0Lypcblx0XHR0aHJvd3MgaWYgdGhlcmUgYXJlIGNvbXBpbGVyIGVycm9ycyBvciB1bnJlc29sdmVkIGZpbGVzXG5cdCovXG5cdHB1YmxpYyBmb3JjZUNoZWNrKCk6IHRzLkRpYWdub3N0aWNbXSB7XG4gICAgICBjb25zdCBmaWxlcyA9IHRoaXMuX2hvc3QuZ2V0QWxsRmlsZXMoKTtcbiAgICAgIGNvbnN0IHVuY2hlY2tlZCA9IGZpbGVzLmZpbHRlcihmaWxlID0+ICFmaWxlLmNoZWNrZWQpO1xuICAgICAgY29uc3QgZXJyb3JlZCA9IGZpbGVzLmZpbHRlcihmaWxlID0+IGZpbGUuY2hlY2tlZCAmJiBoYXNFcnJvcihmaWxlLmVycm9ycykpO1xuICAgICAgXG4gICAgICBpZiAoKGVycm9yZWQubGVuZ3RoID4gMCkgfHwgKHVuY2hlY2tlZC5sZW5ndGggPiAwKSkge1xuICAgICAgICAgcmV0dXJuIFt7XG4gICAgICAgICAgICBmaWxlOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBzdGFydDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgbGVuZ3RoOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBjb2RlOiA5OTk5LFxuICAgICAgICAgICAgY2F0ZWdvcnk6IHRzLkRpYWdub3N0aWNDYXRlZ29yeS5FcnJvcixcbiAgICAgICAgICAgIG1lc3NhZ2VUZXh0OiBgY29tcGlsYXRpb24gZmFpbGVkIFske2ZpbGVzLmxlbmd0aH0gZmlsZXMsICR7ZXJyb3JlZC5sZW5ndGh9IGVycm9yZWQsICR7dW5jaGVja2VkLmxlbmd0aH0gdW5jaGVja2VkXWBcbiAgICAgICAgIH1dO1xuICAgICAgfVxuICAgICAgXG4gICAgICByZXR1cm4gW107IFxuXHR9XG5cbiAgIHByaXZhdGUgZ2V0Q2FuZGlkYXRlcygpIHtcbiAgICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSB0aGlzLl9ob3N0LmdldEFsbEZpbGVzKClcbiAgICAgICAgIC5maWx0ZXIoZmlsZSA9PiBmaWxlLmZpbGVOYW1lICE9IF9fSFRNTF9NT0RVTEVfXylcbiAgICAgICAgIC5tYXAoZmlsZSA9PiAoe1xuICAgICAgICAgICAgbmFtZTogZmlsZS5maWxlTmFtZSxcbiAgICAgICAgICAgIGZpbGU6IGZpbGUsXG4gICAgICAgICAgICBzZWVuOiBmYWxzZSxcbiAgICAgICAgICAgIHJlc29sdmVkOiAhIWZpbGUuZGVwZW5kZW5jaWVzLFxuICAgICAgICAgICAgY2hlY2thYmxlOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBkZXBzOiBmaWxlLmRlcGVuZGVuY2llcyAmJiBmaWxlLmRlcGVuZGVuY2llcy5saXN0XG4gICAgICAgICB9KSk7XG4gICAgICBcbiAgICAgIGNvbnN0IGNhbmRpZGF0ZXNNYXAgPSBjYW5kaWRhdGVzLnJlZHVjZSgocmVzdWx0LCBjYW5kaWRhdGUpID0+IHtcbiAgICAgICAgIHJlc3VsdFtjYW5kaWRhdGUubmFtZV0gPSBjYW5kaWRhdGU7XG4gICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSwge30gYXMgQ2FuZGlkYXRlTWFwKTtcbiAgICAgIFxuICAgICAgY2FuZGlkYXRlcy5mb3JFYWNoKGNhbmRpZGF0ZSA9PiBjYW5kaWRhdGUuY2hlY2thYmxlID0gdGhpcy5pc0NoZWNrYWJsZShjYW5kaWRhdGUsIGNhbmRpZGF0ZXNNYXApKTtcbiAgICAgIHJldHVybiBjYW5kaWRhdGVzO1xuICAgfVxuICAgXG4gICBwcml2YXRlIGlzQ2hlY2thYmxlKGNhbmRpZGF0ZTogQ2FuZGlkYXRlLCBjYW5kaWRhdGVzTWFwOiBDYW5kaWRhdGVNYXApOiBib29sZWFuIHtcbiAgICAgIGlmICghY2FuZGlkYXRlKVxuICAgICAgICAgcmV0dXJuIGZhbHNlOyAgICAgIFxuICAgICAgZWxzZSB7XG4gICAgICAgICBpZiAoIWNhbmRpZGF0ZS5zZWVuKSB7XG4gICAgICAgICAgICBjYW5kaWRhdGUuc2VlbiA9IHRydWU7XG4gICAgICAgICAgICBjYW5kaWRhdGUuY2hlY2thYmxlID0gY2FuZGlkYXRlLnJlc29sdmVkICYmIGNhbmRpZGF0ZS5kZXBzLmV2ZXJ5KGRlcCA9PiB0aGlzLmlzQ2hlY2thYmxlKGNhbmRpZGF0ZXNNYXBbZGVwXSwgY2FuZGlkYXRlc01hcCkpOyAgICAgICAgICAgIFxuICAgICAgICAgfVxuICAgICAgICAgXG4gICAgICAgICByZXR1cm4gKGNhbmRpZGF0ZS5jaGVja2FibGUgIT09IGZhbHNlKTsgLy8gaGFuZGxlcyBjaXJjdWxhciBncmFwaCBiZWNhdXNlIHNlZW4gPSB0cnVlIGJ1dCBjaGVja2FibGUgPSB1bmRlZmllbmRcbiAgICAgIH1cbiAgIH1cbiAgIFxuXHQvKlxuXHRcdFJldHVybnMgdGhlIGRpYWdub3N0aWNzIGZvciB0aGlzIGZpbGUgYW5kIGFueSBmaWxlcyB3aGljaCBpdCB1c2VzLlxuXHRcdEVhY2ggZmlsZSBpcyBvbmx5IGNoZWNrZWQgb25jZS5cblx0Ki9cblx0cHJpdmF0ZSBnZXRBbGxEaWFnbm9zdGljcyhjYW5kaWRhdGVzOiBDYW5kaWRhdGVbXSk6IHRzLkRpYWdub3N0aWNbXSB7XG5cdFx0Ly8gaGFjayB0byBzdXBwb3J0IGh0bWwgaW1wb3J0c1xuICAgICAgbGV0IGZpbGVsaXN0ID0gY2FuZGlkYXRlcy5tYXAoKGRlcCkgPT4gZGVwLm5hbWUpLmNvbmNhdChbX19IVE1MX01PRFVMRV9fXSk7XG5cdFx0bGV0IHByb2dyYW0gPSB0cy5jcmVhdGVQcm9ncmFtKGZpbGVsaXN0LCB0aGlzLl9vcHRpb25zLCB0aGlzLl9ob3N0KTtcblxuXHRcdHJldHVybiBjYW5kaWRhdGVzLnJlZHVjZSgoZXJyb3JzLCBjYW5kaWRhdGUpID0+IHtcblx0XHRcdGlmIChjYW5kaWRhdGUuY2hlY2thYmxlICYmICFjYW5kaWRhdGUuZmlsZS5jaGVja2VkKSB7XG4gICAgICAgICAgICBpZiAoIWNhbmRpZGF0ZS5maWxlLmlzTGliRmlsZSkge1xuICAgICAgICAgICAgICAgZXJyb3JzID0gZXJyb3JzXG4gICAgICAgICAgICAgICAgICAuY29uY2F0KHByb2dyYW0uZ2V0U3ludGFjdGljRGlhZ25vc3RpY3MoY2FuZGlkYXRlLmZpbGUpKVxuICAgICAgICAgICAgICAgICAgLmNvbmNhdChwcm9ncmFtLmdldFNlbWFudGljRGlhZ25vc3RpY3MoY2FuZGlkYXRlLmZpbGUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhbmRpZGF0ZS5maWxlLmVycm9ycyA9IGVycm9ycztcblx0XHRcdFx0Y2FuZGlkYXRlLmZpbGUuY2hlY2tlZCA9IHRydWU7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gZXJyb3JzO1xuXHRcdH0sIHByb2dyYW0uZ2V0R2xvYmFsRGlhZ25vc3RpY3MoKSk7XG5cdH1cbn0iXX0=